<!DOCTYPE html>
<html lang="zh-CN">

<head>
<style>
/* ========== åŸºç¡€é‡ç½®å’Œå¸ƒå±€ ========== */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    background-color: #f5f5f5;
    color: #333;
    line-height: 1.6;
    min-height: 100vh;
}

.container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 20px;
}

/* ========== å¤´éƒ¨æ ·å¼ ========== */
.header {
    background: #2c5aa0;
    color: white;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(44, 90, 160, 0.1);
}

.header h1 {
    font-size: 1.8rem;
    margin-bottom: 10px;
    font-weight: 600;
}

.header p {
    font-size: 1rem;
    opacity: 0.9;
    max-width: 800px;
    margin: 0 auto;
}

/* ========== ä¸»è¦å¸ƒå±€ ========== */
.main-layout {
    display: flex;
    gap: 20px;
    min-height: 70vh;
    align-items: flex-start;
}

.left-panel {
    flex: 1;
    min-width: 60%;
}

.right-panel {
    flex: 0 0 400px;
    background: white;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #ddd;
    height: fit-content;
    position: sticky;
    top: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* ========== å¡ç‰‡æ ·å¼ ========== */
.card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.card-header {
    background: #f8f9fa;
    padding: 15px 20px;
    border-bottom: 1px solid #ddd;
    font-weight: 600;
    color: #2c5aa0;
    font-size: 1.1rem;
}

.card-body {
    padding: 20px;
}

/* ========== ä¸Šä¼ åŒºåŸŸæ ·å¼ ========== */
.upload-area {
    border: 2px dashed #2c5aa0;
    border-radius: 8px;
    padding: 40px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    background: #fafafa;
    display: block;
    overflow: hidden;
}

.upload-area:hover {
    border-color: #1e3d6f;
    background: #f0f8ff;
    transform: translateY(-2px);
}

.upload-area.dragover {
    border-color: #28a745;
    background: #e8f5e8;
    transform: scale(1.02);
}

.upload-icon {
    font-size: 2rem;
    margin-bottom: 15px;
    color: #2c5aa0;
    pointer-events: none;
    position: relative;
    z-index: 1;
}

.upload-area p {
    pointer-events: none;
    position: relative;
    z-index: 1;
    margin: 4px 0;
}

.upload-area p:first-of-type {
    font-weight: 600;
    color: #2c5aa0;
}

.file-input {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
    z-index: 2;
}

/* ========== æŒ‰é’®æ ·å¼ ========== */
.btn {
    background: #2c5aa0;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 6px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    display: inline-block;
    text-decoration: none;
    text-align: center;
}

.btn:hover {
    background: #1e3d6f;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(44, 90, 160, 0.3);
}

.btn:active {
    transform: translateY(0);
}

.btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.btn-secondary {
    background: #6c757d;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-small {
    padding: 8px 16px;
    font-size: 0.9rem;
}

/* ========== åŠ è½½çŠ¶æ€ ========== */
.loading {
    display: none;
    text-align: center;
    padding: 40px;
    background: white;
    border-radius: 8px;
    border: 1px solid #ddd;
    margin-bottom: 20px;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #e9ecef;
    border-top: 3px solid #2c5aa0;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% {
        transform: rotate(0deg);
    }

    100% {
        transform: rotate(360deg);
    }
}

.loading h3 {
    color: #2c5aa0;
    margin-bottom: 10px;
}

.loading p {
    color: #666;
}

/* ========== é”™è¯¯æç¤º ========== */
.error {
    background: #f8d7da;
    color: #721c24;
    padding: 15px;
    border-radius: 6px;
    border: 1px solid #f5c6cb;
    margin: 15px 0;
    display: none;
    font-weight: 500;
}

/* ========== ç»“æœåŒºåŸŸ ========== */
.results {
    display: none;
}

/* ========== é—®é¢˜è¯Šæ–­ ========== */
.issue-item {
    padding: 15px;
    margin: 10px 0;
    border-radius: 6px;
    border-left: 4px solid;
}

.issue-item.high {
    background: #fff5f5;
    border-left-color: #dc3545;
}

.issue-item.medium {
    background: #fff8e1;
    border-left-color: #ffc107;
}

.issue-item.low {
    background: #f8f9fa;
    border-left-color: #6c757d;
}

.issue-item.good {
    background: #f0f9ff;
    border-left-color: #28a745;
}

.issue-title {
    font-weight: 600;
    margin-bottom: 5px;
}

.issue-title.high {
    color: #dc3545;
}

.issue-title.medium {
    color: #ffc107;
}

.issue-title.low {
    color: #6c757d;
}

.issue-title.good {
    color: #28a745;
}

/* ========== å›¾è¡¨å®¹å™¨ ========== */
.chart-container {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

#frequencyChart {
    width: 100%;
    height: 400px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: #fafafa;
}

/* ========== æ›²çº¿æ§åˆ¶ ========== */
.curve-controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin: 20px 0;
    flex-wrap: wrap;
}

.curve-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 15px;
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
    font-size: 14px;
    font-weight: 500;
}

.curve-toggle:hover {
    background: #e9ecef;
    transform: translateY(-1px);
}

.curve-toggle.active {
    background: #e3f2fd;
    border-color: #2c5aa0;
    color: #2c5aa0;
    font-weight: 600;
}

.curve-color {
    width: 20px;
    height: 3px;
    border-radius: 2px;
}

/* ========== é¢‘ç‡èŒƒå›´æ˜¾ç¤º ========== */
.frequency-limits {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin: 20px 0;
}

.limit-box {
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    transition: all 0.3s ease;
}

.limit-box:hover {
    background: #e9ecef;
    transform: translateY(-1px);
}

.limit-title {
    font-weight: 600;
    color: #2c5aa0;
    margin-bottom: 10px;
    font-size: 1rem;
}

.limit-value {
    font-size: 1.2rem;
    color: #333;
    margin: 5px 0;
    font-weight: 700;
}

.limit-label {
    font-size: 0.9rem;
    color: #666;
}

/* ========== æ–‡ä»¶åˆ—è¡¨ ========== */
.file-list {
    margin: 20px 0;
}

.file-item {
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 10px 15px;
    margin: 8px 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.3s ease;
}

.file-item:hover {
    background: #e9ecef;
}

.file-remove {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: all 0.3s ease;
}

.file-remove:hover {
    background: #c82333;
    transform: scale(1.1);
}

/* ========== ä½¿ç”¨è¯´æ˜ ========== */
.instructions ul {
    list-style: none;
    padding: 0;
}

.instructions li {
    margin: 8px 0;
    padding-left: 20px;
    position: relative;
    line-height: 1.6;
}

.instructions li:before {
    content: "âœ“";
    position: absolute;
    left: 0;
    color: #28a745;
    font-weight: bold;
}

/* ========== é‡æ–°ä¸Šä¼ å¡ç‰‡ ========== */
.reupload-card {
    display: none;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 20px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.reupload-btn {
    background: #2c5aa0;
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 8px;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
}

.reupload-btn:hover {
    background: #1e3d6f;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(44, 90, 160, 0.3);
}

/* ========== EQéƒ¨åˆ†æ ·å¼ ========== */
.eq-section {
    margin-bottom: 25px;
}

.eq-section h4 {
    color: #333;
    margin-bottom: 12px;
    font-size: 1.1rem;
    font-weight: 600;
}

.eq-controls {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    flex-wrap: wrap;
    align-items: center;
}

.eq-controls .btn {
    padding: 6px 12px;
    font-size: 0.85rem;
}

.eq-pagination {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
}

.eq-pagination .btn {
    padding: 4px 8px;
    font-size: 0.8rem;
    min-width: 60px;
}

.eq-page-info {
    font-size: 0.8rem;
    color: #666;
    white-space: nowrap;
    font-weight: 500;
}

/* ========== EQæ»‘å—å®¹å™¨ ========== */
.eq-channels-container {
    position: relative;
    overflow: hidden;
    padding: 8px 0 15px 0;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    background: #fafafa;
}

.eq-channels {
    display: flex;
    justify-content: space-evenly;
    align-items: flex-start;
    padding: 0 10px;
}

.eq-channel {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 36px;
    flex-shrink: 0;
}

.eq-frequency-label {
    color: #555;
    font-size: 9px;
    font-weight: 700;
    margin-bottom: 6px;
    text-align: center;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
}

/* ========== EQæ»‘å—æ ·å¼ ========== */
.eq-slider-container {
    position: relative;
    height: 180px;
    width: 26px;
    background: #f1f3f4;
    border: 3px solid #ddd;
    border-radius: 13px;
    margin: 6px 0;
    cursor: pointer;
    transition: all 0.3s ease;
}

.eq-slider-container:hover {
    border-color: #2c5aa0;
    background: #e8f0fe;
}

.eq-slider-track {
    position: absolute;
    top: 10px;
    bottom: 10px;
    left: 50%;
    width: 2px;
    background: #adb5bd;
    transform: translateX(-50%);
}

.eq-slider-center {
    position: absolute;
    top: 50%;
    left: 4px;
    right: 4px;
    height: 2px;
    background: #495057;
    transform: translateY(-50%);
}

.eq-slider-handle {
    position: absolute;
    width: 22px;
    height: 22px;
    background: white;
    border: 3px solid #2c5aa0;
    border-radius: 50%;
    left: 50%;
    transform: translateX(-50%);
    cursor: grab;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.eq-slider-handle:hover {
    transform: translateX(-50%) scale(1.1);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.eq-slider-handle:active {
    cursor: grabbing;
    transform: translateX(-50%) scale(0.95);
}

.eq-slider-handle.positive {
    border-color: #dc3545;
    background: #fff5f5;
}

.eq-slider-handle.negative {
    border-color: #2c5aa0;
    background: #f0f8ff;
}

.eq-value-label {
    color: #333;
    font-size: 9px;
    font-weight: 700;
    margin-top: 6px;
    text-align: center;
    cursor: pointer;
    line-height: 1.2;
    min-height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.eq-value-label:hover {
    background: rgba(44, 90, 160, 0.1);
    border-radius: 3px;
}

.eq-value-label.positive {
    color: #dc3545;
}

.eq-value-label.negative {
    color: #2c5aa0;
}

.eq-value-input {
    background: white;
    border: 2px solid #2c5aa0;
    border-radius: 3px;
    padding: 3px 5px;
    font-size: 9px;
    font-weight: 700;
    text-align: center;
    width: 40px;
    color: #2c5aa0;
    outline: none;
    box-shadow: 0 2px 4px rgba(44, 90, 160, 0.3);
}

/* ========== éŸ³é¢‘è¯•å¬éƒ¨åˆ† ========== */
.audio-test-section {
    margin-top: 25px;
    padding-top: 20px;
    border-top: 2px solid #e9ecef;
}

.audio-upload-area {
    border: 2px dashed #17a2b8;
    border-radius: 8px;
    padding: 15px 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    margin-bottom: 15px;
    overflow: hidden;
    background: #f8f9fa;
}

.audio-upload-area:hover {
    border-color: #138496;
    background: #e6f7ff;
    transform: translateY(-1px);
}

.audio-upload-area.dragover {
    border-color: #28a745;
    background: #e8f5e8;
    transform: scale(1.02);
}

.audio-upload-area .upload-icon {
    font-size: 1.5rem;
    margin-bottom: 8px;
    pointer-events: none;
    color: #17a2b8;
}

.audio-upload-area p {
    font-size: 0.9rem;
    margin: 4px 0;
    pointer-events: none;
}

.audio-upload-area p:first-of-type {
    font-weight: 600;
    color: #17a2b8;
}

/* ========== éŸ³é¢‘æ§åˆ¶é¢æ¿ ========== */
.audio-controls-panel {
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    display: none;
}

.audio-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.audio-info {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 10px;
    font-weight: 500;
}

/* ========== è¿›åº¦æ¡ ========== */
.progress-container {
    position: relative;
    width: 100%;
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    margin: 10px 0;
    cursor: pointer;
    overflow: hidden;
}

.progress-container:hover {
    background: #dee2e6;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #2c5aa0, #4a90e2);
    border-radius: 3px;
    width: 0%;
    transition: width 0.1s ease;
}

.time-display {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    color: #666;
    margin-top: 5px;
    font-weight: 500;
}

/* ========== EQé€‰æ‹©å™¨ ========== */
.eq-selection {
    margin-bottom: 15px;
}

.eq-toggle-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.eq-toggle-button {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
    font-size: 13px;
    font-weight: 500;
}

.eq-toggle-button:hover {
    background: #e9ecef;
    border-color: #adb5bd;
    transform: translateY(-1px);
}

.eq-toggle-button.active {
    background: #e3f2fd;
    border-color: #2c5aa0;
    color: #2c5aa0;
    font-weight: 600;
}

.eq-toggle-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #adb5bd;
    transition: all 0.3s ease;
}

.eq-toggle-button.active .eq-toggle-indicator {
    background: #2c5aa0;
}

/* ========== éŸ³é‡æ§åˆ¶ ========== */
.volume-control {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 15px;
}

.volume-slider {
    flex: 1;
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    outline: none;
    -webkit-appearance: none;
    cursor: pointer;
    transition: all 0.3s ease;
}

.volume-slider:hover {
    background: #dee2e6;
}

.volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #2c5aa0;
    cursor: pointer;
    transition: all 0.3s ease;
}

.volume-slider::-webkit-slider-thumb:hover {
    background: #1e3d6f;
    transform: scale(1.2);
}

.volume-slider::-moz-range-thumb {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #2c5aa0;
    cursor: pointer;
    border: none;
    transition: all 0.3s ease;
}

.volume-slider::-moz-range-thumb:hover {
    background: #1e3d6f;
    transform: scale(1.2);
}

/* ========== å“åº¦æŒ‡ç¤ºå™¨ ========== */
.loudness-indicator {
    margin-top: 10px;
    padding: 8px 12px;
    background: #e3f2fd;
    border: 1px solid #bbdefb;
    border-radius: 4px;
    font-size: 0.8rem;
    color: #1565c0;
    font-weight: 500;
}

/* ========== é¢‘ç‡èŒƒå›´æ§åˆ¶ ========== */
.frequency-range-controls {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.range-input-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.range-input-group label {
    font-size: 0.9rem;
    font-weight: 600;
    color: #333;
}

.range-input {
    padding: 8px 12px;
    border: 2px solid #ddd;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 600;
    text-align: center;
    width: 120px;
    transition: all 0.3s ease;
    outline: none;
}

.range-input:focus {
    border-color: #2c5aa0;
    box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
}

.range-input:invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
}

/* ========== å“åº”å¼è®¾è®¡ ========== */
@media (max-width: 1200px) {
    .main-layout {
        flex-direction: column;
    }

    .right-panel {
        flex: none;
        position: static;
        max-width: none;
    }

    .container {
        padding: 15px;
    }
}

@media (max-width: 768px) {
    .header {
        padding: 15px;
    }

    .header h1 {
        font-size: 1.5rem;
    }

    .header p {
        font-size: 0.9rem;
    }

    .frequency-limits {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .curve-controls {
        gap: 8px;
        margin: 15px 0;
    }

    .curve-toggle {
        padding: 6px 12px;
        font-size: 12px;
    }

    .right-panel {
        padding: 10px;
    }

    .eq-channel {
        width: 32px;
    }

    .eq-slider-container {
        width: 22px;
        height: 160px;
    }

    .eq-slider-handle {
        width: 18px;
        height: 18px;
    }

    .eq-toggle-buttons {
        flex-direction: column;
        gap: 6px;
    }

    .eq-toggle-button {
        justify-content: center;
        padding: 10px 15px;
    }

    .chart-container {
        padding: 15px;
    }

    .card-body {
        padding: 15px;
    }
}

@media (max-width: 480px) {
    .container {
        padding: 10px;
    }

    .header {
        padding: 10px;
        margin-bottom: 15px;
    }

    .header h1 {
        font-size: 1.3rem;
    }

    .header p {
        font-size: 0.8rem;
    }

    .eq-section .eq-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 6px;
    }

    .eq-section .eq-controls .btn {
        margin-right: 0;
        margin-bottom: 8px;
        width: 100%;
        padding: 10px;
    }

    .eq-pagination {
        margin-left: 0;
        margin-top: 10px;
    }

    .audio-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
    }

    .upload-area {
        padding: 20px 15px;
    }

    .audio-upload-area {
        padding: 12px 8px;
    }

    .frequency-range-controls {
        gap: 12px;
    }

    .range-input {
        width: 100%;
    }

    .limit-box {
        padding: 12px;
    }

    .limit-value {
        font-size: 1.1rem;
    }
}

/* ========== ç‰¹æ®Šæ•ˆæœå’ŒåŠ¨ç”» ========== */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card,
.upload-area,
.audio-upload-area {
    animation: fadeIn 0.3s ease-out;
}

/* ========== æ— éšœç¢æ”¯æŒ ========== */
@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* é«˜å¯¹æ¯”åº¦æ¨¡å¼æ”¯æŒ */
@media (prefers-contrast: high) {
    .btn {
        border: 2px solid;
    }

    .upload-area,
    .audio-upload-area {
        border-width: 3px;
    }

    .eq-slider-handle {
        border-width: 4px;
    }
}

/* æ·±è‰²ä¸»é¢˜æ”¯æŒ */
@media (prefers-color-scheme: dark) {
    body {
        background-color: #1a1a1a;
        color: #e0e0e0;
    }

    .card,
    .right-panel,
    .audio-controls-panel {
        background: #2d2d2d;
        border-color: #404040;
        color: #e0e0e0;
    }

    .card-header {
        background: #3a3a3a;
        border-color: #404040;
    }

    .upload-area,
    .audio-upload-area {
        background: #2d2d2d;
        border-color: #2c5aa0;
    }

    .upload-area:hover,
    .audio-upload-area:hover {
        background: #353535;
    }

    #frequencyChart {
        background: #2d2d2d;
    }
}

/* ========== æ‰“å°æ ·å¼ ========== */
@media print {
    .header {
        background: white !important;
        color: black !important;
        box-shadow: none;
    }

    .btn,
    .audio-controls,
    .eq-controls {
        display: none;
    }

    .main-layout {
        flex-direction: column;
    }

    .right-panel {
        position: static;
        max-width: none;
        box-shadow: none;
    }
}


/* ========== å¯æŠ˜å å¡ç‰‡æ ·å¼ ========== */
.collapsible-card {
    overflow: hidden;
}

.collapsible-header {
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none;
    transition: background-color 0.3s ease;
}

.collapsible-header:hover {
    background-color: #e9ecef;
}

.collapse-icon {
    font-size: 14px;
    font-weight: bold;
    color: #2c5aa0;
    transition: transform 0.3s ease;
    margin-left: 10px;
}

.collapse-icon.collapsed {
    transform: rotate(-90deg);
}

.collapsible-content {
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.4s ease, padding 0.4s ease;
}

.collapsible-content.collapsed {
    max-height: 0;
    padding-top: 0;
    padding-bottom: 0;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
    .collapsible-header {
        padding: 12px 15px;
    }

    .collapse-icon {
        font-size: 12px;
    }
}

.smoothing-control-group {
    margin: 20px 0;
    padding: 15px;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    border-left: 4px solid #2c5aa0;
}

.smoothing-control {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.smoothing-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    font-weight: 500;
    color: #333;
    user-select: none;
}

.smoothing-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: #2c5aa0;
    cursor: pointer;
}

.control-text {
    font-size: 1rem;
    color: #2c5aa0;
    font-weight: 600;
}

.control-info {
    font-size: 14px;
    color: #6c757d;
    cursor: help;
    background: #e9ecef;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    transition: all 0.3s ease;
}

.control-info:hover {
    background: #2c5aa0;
    color: white;
    transform: scale(1.1);
}

.control-description {
    margin-left: 28px;
    color: #6c757d;
    font-style: italic;
}

.control-description small {
    font-size: 0.85rem;
    line-height: 1.4;
}

.algorithm-status-container {
    margin-bottom: 25px;
}

.algorithm-status-section {
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 20px;
}

.algorithm-status {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    transition: all 0.3s ease;
}

.algorithm-status.enabled {
    background: #d4edda;
    border-color: #c3e6cb;
    border-left: 4px solid #28a745;
}

.algorithm-status.disabled {
    background: #fff3cd;
    border-color: #ffeaa7;
    border-left: 4px solid #ffc107;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
}

.status-icon {
    font-size: 16px;
    font-weight: bold;
}

.algorithm-status.enabled .status-icon {
    color: #28a745;
}

.algorithm-status.disabled .status-icon {
    color: #ffc107;
}

.status-text {
    font-weight: 600;
    font-size: 1rem;
}

.algorithm-status.enabled .status-text {
    color: #155724;
}

.algorithm-status.disabled .status-text {
    color: #856404;
}

.status-description {
    color: #6c757d;
    font-style: italic;
}

.algorithm-status.enabled .status-description {
    color: #155724;
}

.algorithm-status.disabled .status-description {
    color: #856404;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
    .smoothing-label {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }

    .control-description {
        margin-left: 0;
        margin-top: 5px;
    }

    .status-indicator {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }
}

*/


.algorithm-selector-section {
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 20px;
    margin-bottom: 25px;
}

.algorithm-selector {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 15px;
}

.algorithm-option {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.algorithm-option:hover {
    border-color: #2c5aa0;
    background: #f0f8ff;
    transform: translateY(-1px);
}

.algorithm-option:has(input:checked) {
    border-color: #2c5aa0;
    background: #e3f2fd;
    box-shadow: 0 2px 8px rgba(44, 90, 160, 0.15);
}

.algorithm-label {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    cursor: pointer;
    user-select: none;
    margin: 0;
}

.algorithm-label input[type="radio"] {
    width: 20px;
    height: 20px;
    accent-color: #2c5aa0;
    cursor: pointer;
    margin: 0;
    flex-shrink: 0;
}

.radio-checkmark {
    width: 20px;
    height: 20px;
    border: 2px solid #2c5aa0;
    border-radius: 50%;
    position: relative;
    flex-shrink: 0;
    background: white;
    transition: all 0.3s ease;
}

.algorithm-label input:checked + .radio-checkmark {
    background: #2c5aa0;
    border-color: #2c5aa0;
}

.algorithm-label input:checked + .radio-checkmark::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    transform: translate(-50%, -50%);
}

.algorithm-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.algorithm-title {
    font-weight: 600;
    font-size: 1rem;
    color: #2c5aa0;
    line-height: 1.2;
}

.algorithm-desc {
    font-size: 0.9rem;
    color: #6c757d;
    line-height: 1.3;
}

.algorithm-actions {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}

.btn-algorithm {
    background: #2c5aa0;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
}

.btn-algorithm:hover:not(:disabled) {
    background: #1e3d6f;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(44, 90, 160, 0.3);
}

.btn-algorithm:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.algorithm-status {
    font-size: 0.9rem;
    font-weight: 500;
    padding: 8px 12px;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.algorithm-status.applied {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.algorithm-status.pending {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
    .algorithm-selector {
        gap: 12px;
    }
    
    .algorithm-option {
        padding: 12px;
    }
    
    .algorithm-label {
        gap: 10px;
    }
    
    .algorithm-title {
        font-size: 0.95rem;
    }
    
    .algorithm-desc {
        font-size: 0.85rem;
    }
    
    .algorithm-actions {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }
    
    .btn-algorithm {
        width: 100%;
        padding: 12px;
    }
    
    .algorithm-status {
        text-align: center;
    }
}

/* éšè—é»˜è®¤å•é€‰æŒ‰é’®æ ·å¼ */
.algorithm-label input[type="radio"] {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
}
*/


/* å¯æŠ˜å åŒºåŸŸæ ·å¼ */
.collapsible-section {
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    margin-bottom: 20px;
    overflow: hidden;
    transition: all 0.3s ease;
}

.collapsible-header {
    background: #f8f9fa;
    padding: 15px 20px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e0e0e0;
    transition: background-color 0.2s ease;
    user-select: none;
}

.collapsible-header:hover {
    background: #e9ecef;
}

.collapsible-header h4 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #333;
}

.collapse-icon {
    font-size: 14px;
    color: #666;
    transition: transform 0.3s ease;
    font-weight: bold;
}

.collapse-icon.collapsed {
    transform: rotate(-90deg);
}

.collapsible-content {
    padding: 20px;
    background: #fff;
    max-height: 1000px;
    overflow: hidden;
    transition: all 0.4s ease;
}

.collapsible-content.collapsed {
    max-height: 0;
    padding-top: 0;
    padding-bottom: 0;
    opacity: 0;
}

/* ç‰¹å®šåŒºåŸŸçš„æ ·å¼è°ƒæ•´ */
.algorithm-section.collapsible-section {
    border-color: #007bff;
}

.algorithm-section .collapsible-header {
    background: linear-gradient(135deg, #f0f7ff 0%, #e3f2fd 100%);
    border-bottom-color: #007bff;
}

.frequency-range-section.collapsible-section {
    border-color: #e0e0e0;
}

/* ç‰¹å®šåŒºåŸŸçš„æ ·å¼è°ƒæ•´ - ç»Ÿä¸€ç™½è‰²èƒŒæ™¯ */
.frequency-range-section .collapsible-header {
    background: #f8f9fa; /* ç»Ÿä¸€èƒŒæ™¯è‰²ï¼Œä¸é»˜è®¤æ ·å¼ä¸€è‡´ */
    border-bottom-color: #e0e0e0; /* ç»Ÿä¸€è¾¹æ¡†é¢œè‰² */
}

/* ä¿æŒåŸæœ‰çš„åŠŸèƒ½åŒºåŸŸå†…éƒ¨æ ·å¼ä¸å˜ */
.collapsible-content .algorithm-selector,
.collapsible-content .frequency-range-controls {
    margin: 0;
}

.collapsible-content .algorithm-actions,
.collapsible-content .range-input-group {
    margin-top: 15px;
}

.collapsible-content p {
    margin-bottom: 0;
}
</style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³ç®±é¢‘å“ä¼˜åŒ–å·¥å…·</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>éŸ³ç®±é¢‘å“ä¼˜åŒ–å·¥å…·</h1>
            <p>éŸ³ç®±é¢‘å“åˆ†æã€å®æ—¶EQè°ƒèŠ‚ä¸é¢„æµ‹ | æ”¯æŒæœ€å¤š10ä¸ªæ–‡ä»¶ | å“åº¦è¡¥å¿è¯•å¬</p>
        </div>

        <div class="main-layout">
            <div class="left-panel">
                <!-- ä½¿ç”¨è¯´æ˜å¡ç‰‡ -->
                <div class="card" id="instructionsCard">
                    <div class="card-header">ä½¿ç”¨è¯´æ˜</div>
                    <div class="card-body instructions">
                        <ul>
                            <li>ä¸Šä¼ 1-10ä¸ªç²‰çº¢å™ªå£°å½•éŸ³æ–‡ä»¶ï¼ˆæ”¯æŒWAVã€MP3ã€FLACç­‰æ ¼å¼ï¼‰</li>
                            <li>ç³»ç»Ÿè‡ªåŠ¨å¹³å‡å¤šä¸ªæ–‡ä»¶çš„é¢‘è°±å¹¶åˆ†æéŸ³ç®±é¢‘å“ç‰¹æ€§</li>
                            <li>æ‹–æ‹½å³ä¾§æ»‘å—å®æ—¶è°ƒèŠ‚EQå€¼ï¼Œå›¾è¡¨åŒæ­¥æ›´æ–°é¢„æµ‹æ•ˆæœ</li>
                            <li>åŒå‡»æ•°å€¼æ ‡ç­¾å¯ç›´æ¥è¾“å…¥æ•°å­—è¿›è¡Œç²¾ç¡®è°ƒèŠ‚</li>
                            <li>ä¸Šä¼ è¯•å¬éŸ³é¢‘æ–‡ä»¶å¯å®æ—¶ä½“éªŒEQæ•ˆæœï¼Œæ”¯æŒæ— ç¼åˆ‡æ¢</li>
                            <li>åŸºäºäººè€³æ•æ„Ÿåº¦çš„æ™ºèƒ½å“åº¦è¡¥å¿ç¡®ä¿ä¸åŒEQè®¾ç½®ä¸‹éŸ³é‡ä¸€è‡´</li>
                        </ul>
                    </div>
                </div>

                <!-- éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ å¡ç‰‡ -->
                <div class="card" id="uploadCard">
                    <div class="card-header">ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶</div>
                    <div class="card-body">
                        <div class="upload-area" id="fileDropArea">
                            <div class="upload-icon">ğŸµ</div>
                            <p><strong>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œ</strong></p>
                            <p>æ”¯æŒ WAVã€MP3ã€FLAC ç­‰éŸ³é¢‘æ ¼å¼ | æœ€å¤š10ä¸ªæ–‡ä»¶</p>
                            <input type="file" id="audioFiles" class="file-input" multiple accept="audio/*">
                        </div>
                        <div id="fileList" class="file-list"></div>
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="analyzeAudio()" class="btn" id="analyzeBtn">å¼€å§‹åˆ†æ</button>
                        </div>
                    </div>
                </div>

                <!-- é‡æ–°ä¸Šä¼ å¡ç‰‡ -->
                <div class="reupload-card" id="reuploadCard">
                    <p style="margin-bottom: 15px; color: #666;">æƒ³è¦åˆ†æå…¶ä»–éŸ³é¢‘æ–‡ä»¶ï¼Ÿ</p>
                    <button onclick="resetToUpload()" class="reupload-btn">é‡æ–°ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶</button>
                </div>

                <!-- éŸ³ç®±é—®é¢˜è¯Šæ–­å¡ç‰‡ -->
                <div id="speakerIssues" class="card collapsible-card" style="display: none;">
                    <div class="card-header collapsible-header" onclick="toggleSpeakerIssues()">
                        <span>éŸ³ç®±é—®é¢˜è¯Šæ–­</span>
                        <span class="collapse-icon" id="speakerIssuesIcon">â–¼</span>
                    </div>
                    <div class="card-body collapsible-content" id="issuesContent"></div>
                </div>

                <!-- åŠ è½½çŠ¶æ€ -->
                <div id="loading" class="loading">
                    <div class="loading-spinner"></div>
                    <h3>æ­£åœ¨åˆ†æä¸­...</h3>
                    <p>æ­£åœ¨å¤„ç†éŸ³é¢‘æ•°æ®å¹¶ç”Ÿæˆé¢‘å“åˆ†æï¼Œè¯·ç¨å€™</p>
                </div>

                <!-- é”™è¯¯æç¤º -->
                <div id="error" class="error"></div>

                <!-- åˆ†æç»“æœ -->
                <div id="results" class="results">
                    <div class="card">
                        <div class="card-header">é¢‘å“åˆ†æå›¾è¡¨</div>
                        <div class="card-body">
                            <!-- æ›²çº¿æ§åˆ¶ -->
                            <div class="curve-controls" id="curveControls">
                                <div class="curve-toggle active" data-curve="original">
                                    <div class="curve-color" style="background-color: #e57373;"></div>
                                    <span>åŸå§‹æµ‹é‡</span>
                                </div>
                                <div class="curve-toggle active" data-curve="eq15">
                                    <div class="curve-color" style="background-color: #81c784;"></div>
                                    <span>15æ®µEQåé¢„æµ‹</span>
                                </div>
                                <div class="curve-toggle active" data-curve="eq31">
                                    <div class="curve-color" style="background-color: #64b5f6;"></div>
                                    <span>31æ®µEQåé¢„æµ‹</span>
                                </div>
                            </div>

                            <!-- å›¾è¡¨å®¹å™¨ -->
                            <div class="chart-container">
                                <svg id="frequencyChart" width="100%" height="400" viewBox="0 0 800 400"></svg>
                            </div>

                            <!-- é¢‘ç‡èŒƒå›´æ˜¾ç¤º -->
                            <div class="frequency-limits" id="frequencyLimits">
                                <div class="limit-box">
                                    <div class="limit-title">15æ®µEQè°ƒèŠ‚åçš„é¢‘ç‡èŒƒå›´ï¼ˆ-6dBç‚¹ï¼‰</div>
                                    <div class="limit-value" id="eq15LowLimit">-- Hz</div>
                                    <div class="limit-label">ä½é¢‘æé™</div>
                                    <div class="limit-value" id="eq15HighLimit">-- Hz</div>
                                    <div class="limit-label">é«˜é¢‘æé™</div>
                                </div>
                                <div class="limit-box">
                                    <div class="limit-title">31æ®µEQè°ƒèŠ‚åçš„é¢‘ç‡èŒƒå›´ï¼ˆ-6dBç‚¹ï¼‰</div>
                                    <div class="limit-value" id="eq31LowLimit">-- Hz</div>
                                    <div class="limit-label">ä½é¢‘æé™</div>
                                    <div class="limit-value" id="eq31HighLimit">-- Hz</div>
                                    <div class="limit-label">é«˜é¢‘æé™</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§æ§åˆ¶é¢æ¿ -->
            <div class="right-panel">
                <div id="eqConsole" style="display: none;">
                    <!-- æ•°æ®å¯¼å‡ºéƒ¨åˆ† -->
                    <div class="eq-section"
                        style="border-bottom: 2px solid #e9ecef; padding-bottom: 20px; margin-bottom: 25px;">
                        <h4>æ•°æ®å¯¼å‡º</h4>
                        <div class="eq-controls">
                            <button class="btn" onclick="exportEQData('15')"
                                style="background: #28a745;">å¯¼å‡º15æ®µEQ</button>
                            <button class="btn" onclick="exportEQData('31')"
                                style="background: #17a2b8;">å¯¼å‡º31æ®µEQ</button>
                            <button class="btn btn-secondary" onclick="exportBothEQData()">å¯¼å‡ºå…¨éƒ¨</button>
                        </div>
                        <p style="font-size: 12px; color: #666; margin-top: 8px; margin-bottom: 0;">
                            å¯¼å‡ºå½“å‰EQè°ƒèŠ‚å€¼ä¸ºCSVæ ¼å¼ï¼Œå¯ç›´æ¥å¯¼å…¥å…¶ä»–éŸ³é¢‘è®¾å¤‡
                        </p>
                    </div>

                    <!-- ç›®æ ‡é¢‘ç‡èŒƒå›´è®¾ç½® -->
                    <div class="eq-section"
                        style="border-bottom: 2px solid #e9ecef; padding-bottom: 20px; margin-bottom: 25px;">
                        <h4>ç›®æ ‡é¢‘ç‡èŒƒå›´</h4>
                        <div class="frequency-range-controls">
                            <div class="range-input-group">
                                <label for="targetLowFreq">ç›®æ ‡ä½é¢‘ä¸‹æ½œ (Hz)</label>
                                <input type="number" id="targetLowFreq" class="range-input" min="20" max="1000" step="1"
                                    value="20" onchange="updateFrequencyRange()">
                            </div>
                            <div class="range-input-group">
                                <label for="targetHighFreq">ç›®æ ‡é«˜é¢‘å»¶ä¼¸ (Hz)</label>
                                <input type="number" id="targetHighFreq" class="range-input" min="1000" max="20000"
                                    step="100" value="20000" onchange="updateFrequencyRange()">
                            </div>
                            <button class="btn" onclick="reoptimizeEQ()"
                                style="background: #2c5aa0; color: white; margin-top: 10px;">
                                é‡æ–°ä¼˜åŒ–EQ
                            </button>
                        </div>
                        <p style="font-size: 12px; color: #666; margin-top: 8px; margin-bottom: 0;">
                            è®¾å®šEQä¼˜åŒ–çš„é¢‘ç‡èŒƒå›´ï¼Œè¶…å‡ºèŒƒå›´çš„é¢‘æ®µå°†ä¸åšå¤„ç†
                        </p>
                    </div>

                    <!-- 15æ®µEQè°ƒèŠ‚ -->
                    <div class="eq-section">
                        <h4>15æ®µEQè°ƒèŠ‚</h4>
                        <div class="eq-controls">
                            <button class="btn btn-secondary" onclick="resetEQ('15')">é‡ç½®</button>
                            <button class="btn btn-secondary" onclick="zeroAllEQ('15')">å½’é›¶</button>
                            <div class="eq-pagination">
                                <button class="btn btn-secondary" id="eq15PrevBtn"
                                    onclick="changePage('15', -1)">ä¸Šä¸€é¡µ</button>
                                <div class="eq-page-info" id="eq15PageInfo">ç¬¬1é¡µ/å…±2é¡µ</div>
                                <button class="btn btn-secondary" id="eq15NextBtn"
                                    onclick="changePage('15', 1)">ä¸‹ä¸€é¡µ</button>
                            </div>
                        </div>
                        <div class="eq-channels-container">
                            <div class="eq-channels" id="eq15Channels"></div>
                        </div>
                    </div>

                    <!-- 31æ®µEQè°ƒèŠ‚ -->
                    <div class="eq-section">
                        <h4>31æ®µEQè°ƒèŠ‚</h4>
                        <div class="eq-controls">
                            <button class="btn btn-secondary" onclick="resetEQ('31')">é‡ç½®</button>
                            <button class="btn btn-secondary" onclick="zeroAllEQ('31')">å½’é›¶</button>
                            <div class="eq-pagination">
                                <button class="btn btn-secondary" id="eq31PrevBtn"
                                    onclick="changePage('31', -1)">ä¸Šä¸€é¡µ</button>
                                <div class="eq-page-info" id="eq31PageInfo">ç¬¬1é¡µ/å…±4é¡µ</div>
                                <button class="btn btn-secondary" id="eq31NextBtn"
                                    onclick="changePage('31', 1)">ä¸‹ä¸€é¡µ</button>
                            </div>
                        </div>
                        <div class="eq-channels-container">
                            <div class="eq-channels" id="eq31Channels"></div>
                        </div>
                    </div>

                    <!-- EQæ•ˆæœè¯•å¬ -->
                    <div class="eq-section audio-test-section">
                        <h4>EQæ•ˆæœè¯•å¬</h4>

                        <!-- EQç±»å‹é€‰æ‹© -->
                        <div class="eq-selection">
                            <div class="eq-toggle-buttons">
                                <div class="eq-toggle-button active" data-eq-type="none">
                                    <div class="eq-toggle-indicator"></div>
                                    <span>æ— EQæ•ˆæœ</span>
                                </div>
                                <div class="eq-toggle-button" data-eq-type="eq15">
                                    <div class="eq-toggle-indicator"></div>
                                    <span>åº”ç”¨15æ®µEQ</span>
                                </div>
                                <div class="eq-toggle-button" data-eq-type="eq31">
                                    <div class="eq-toggle-indicator"></div>
                                    <span>åº”ç”¨31æ®µEQ</span>
                                </div>
                            </div>
                        </div>

                        <!-- éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                        <div id="audioUploadArea" class="audio-upload-area">
                            <div class="upload-icon">ğŸ§</div>
                            <p><strong>é€‰æ‹©è¯•å¬éŸ³é¢‘æ–‡ä»¶</strong></p>
                            <p>æ”¯æŒ WAVã€MP3ã€FLAC ç­‰æ ¼å¼</p>
                            <input type="file" id="testAudioFile" class="file-input" accept="audio/*">
                        </div>

                        <!-- éŸ³é¢‘æ’­æ”¾æ§åˆ¶é¢æ¿ -->
                        <div id="audioControlsPanel" class="audio-controls-panel">
                            <div class="audio-info" id="audioInfo">æœªé€‰æ‹©æ–‡ä»¶</div>

                            <!-- æ’­æ”¾æ§åˆ¶æŒ‰é’® -->
                            <div class="audio-controls">
                                <button id="playPauseBtn" class="btn btn-small" onclick="togglePlayPause()">æ’­æ”¾</button>
                                <button id="stopBtn" class="btn btn-secondary btn-small"
                                    onclick="stopAudio()">åœæ­¢</button>
                                <button id="rewindBtn" class="btn btn-secondary btn-small"
                                    onclick="rewindAudio()">é‡ç½®</button>
                            </div>

                            <!-- è¿›åº¦æ¡ -->
                            <div class="progress-container" onclick="seekAudio(event)">
                                <div class="progress-bar" id="progressBar"></div>
                            </div>

                            <!-- æ—¶é—´æ˜¾ç¤º -->
                            <div class="time-display">
                                <span id="currentTime">0:00</span>
                                <span id="totalTime">0:00</span>
                            </div>

                            <!-- éŸ³é‡æ§åˆ¶ -->
                            <div class="volume-control">
                                <span>ğŸ”ˆ</span>
                                <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100"
                                    value="25">
                                <span id="volumeValue">25%</span>
                            </div>

                            <!-- å“åº¦è¡¥å¿æŒ‡ç¤ºå™¨ -->
                            <div class="loudness-indicator" id="loudnessIndicator">
                                æ™ºèƒ½å“åº¦è¡¥å¿: 0.0dB (åŸºäºäººè€³æ•æ„Ÿåº¦ç¡®ä¿éŸ³é‡ä¸€è‡´)
                            </div>
                        </div>
                    </div>
                </div>

                <!-- EQæ§åˆ¶å°å ä½ç¬¦ -->
                <div id="eqPlaceholder" style="text-align: center; color: #999; padding: 40px 20px;">
                    <p>åˆ†æå®Œæˆåï¼Œè¿™é‡Œå°†æ˜¾ç¤ºEQè°ƒèŠ‚æ§åˆ¶å°</p>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
<script>
// è‡ªåŠ¨æ‰“åŒ…ç”Ÿæˆ - 2025-09-06 17:19:28
// æ–‡ä»¶é¡ºåº: web.js
// æ¨¡å—è¯´æ˜: core.js(åŸºç¡€ç®—æ³•) -> chart.js(å›¾è¡¨ç»˜åˆ¶) -> audio.js(éŸ³é¢‘å¤„ç†)

// ===== web.js å¼€å§‹ =====
// web.js
/**
 * ç²‰çº¢å™ªå£°EQåˆ†æå·¥å…· - å‰ç«¯JavaScriptå®ç°
 * åŠŸèƒ½ï¼šéŸ³é¢‘æ–‡ä»¶ä¸Šä¼ ã€é¢‘å“åˆ†æã€EQè°ƒèŠ‚ã€å®æ—¶é¢„è§ˆã€éŸ³é¢‘è¯•å¬
 */

// å…¨å±€å˜é‡
let selectedFiles = [];
let analysisResults = null;
let currentChart = null;
let currentAudio = null;
let audioContext = null;
let currentEQType = 'none';
let isPlaying = false;
let currentTime = 0;
let totalDuration = 0;

// EQè®¾ç½®
let eq15Settings = new Array(15).fill(0);
let eq31Settings = new Array(31).fill(0);
let eq15PageIndex = 0;
let eq31PageIndex = 0;
const eq15PerPage = 8;
const eq31PerPage = 8;

// é¢‘ç‡èŒƒå›´è®¾ç½®
let targetLowFreq = 20;
let targetHighFreq = 20000;

// æ›²çº¿æ˜¾ç¤ºæ§åˆ¶
let curveVisibility = {
    original: true,
    eq15: true,
    eq31: true
};

let audioSource = null;
let gainNode = null;
let eq15FilterNodes = [];
let eq31FilterNodes = [];
let analyzerNode = null;


let preGainNode = null;

let speakerIssuesCollapsed = false;

// åœ¨ç°æœ‰å…¨å±€å˜é‡åæ·»åŠ 
let algorithmSectionCollapsed = false;
let frequencyRangeSectionCollapsed = false;

// éŸ³é¢‘å¤„ç†å¸¸é‡
const PRE_GAIN_DB = -12; // ç»Ÿä¸€é¢„è¡°å‡12dBï¼Œä¸ºEQå¢ç›Šç•™å‡ºå‡€ç©º
const PRE_GAIN_LINEAR = Math.pow(10, PRE_GAIN_DB / 20); // è½¬æ¢ä¸ºçº¿æ€§å¢ç›Š

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function () {
    initializeUploadArea();
    initializeEQControls();
    initializeImprovedAudioControls();
    initializeCurveControls();
    initializeFrequencyControls();

    console.log('éŸ³ç®±æ ¡å‡†å·¥å…·åˆå§‹åŒ–å®Œæˆ');
});

/**
 * åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
 */
function initializeUploadArea() {
    const fileInput = document.getElementById('audioFiles');
    const dropArea = document.getElementById('fileDropArea');
    const fileList = document.getElementById('fileList');

    // æ–‡ä»¶é€‰æ‹©
    fileInput.addEventListener('change', handleFileSelection);

    // æ‹–æ‹½ä¸Šä¼ 
    dropArea.addEventListener('dragover', handleDragOver);
    dropArea.addEventListener('dragleave', handleDragLeave);
    dropArea.addEventListener('drop', handleFileDrop);
    dropArea.addEventListener('click', () => fileInput.click());

    function handleFileSelection(e) {
        const files = Array.from(e.target.files);
        addFiles(files);
    }

    function handleDragOver(e) {
        e.preventDefault();
        dropArea.classList.add('dragover');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        dropArea.classList.remove('dragover');
    }

    function handleFileDrop(e) {
        e.preventDefault();
        dropArea.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files);
        addFiles(files);
    }

    function addFiles(files) {
        // è¿‡æ»¤éŸ³é¢‘æ–‡ä»¶
        const audioFiles = files.filter(file => file.type.startsWith('audio/'));

        if (audioFiles.length === 0) {
            showError('è¯·é€‰æ‹©æœ‰æ•ˆçš„éŸ³é¢‘æ–‡ä»¶');
            return;
        }

        // é™åˆ¶æœ€å¤š10ä¸ªæ–‡ä»¶
        const remainingSlots = 10 - selectedFiles.length;
        const filesToAdd = audioFiles.slice(0, remainingSlots);

        selectedFiles.push(...filesToAdd);
        updateFileList();

        if (filesToAdd.length < audioFiles.length) {
            showError(`æœ€å¤šæ”¯æŒ10ä¸ªæ–‡ä»¶ï¼Œå·²æ·»åŠ ${filesToAdd.length}ä¸ªæ–‡ä»¶`);
        }

        // å¯ç”¨åˆ†ææŒ‰é’®
        document.getElementById('analyzeBtn').disabled = false;
    }

    function updateFileList() {
        fileList.innerHTML = '';

        selectedFiles.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <span>${file.name} (${formatFileSize(file.size)})</span>
                <button class="file-remove" onclick="removeFile(${index})">Ã—</button>
            `;
            fileList.appendChild(fileItem);
        });

        if (selectedFiles.length === 0) {
            document.getElementById('analyzeBtn').disabled = true;
        }
    }
}

/**
 * ç§»é™¤æ–‡ä»¶
 */
function removeFile(index) {
    selectedFiles.splice(index, 1);
    document.querySelector('#fileList').innerHTML = '';

    // é‡æ–°ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨
    const fileList = document.getElementById('fileList');
    selectedFiles.forEach((file, i) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
            <span>${file.name} (${formatFileSize(file.size)})</span>
            <button class="file-remove" onclick="removeFile(${i})">Ã—</button>
        `;
        fileList.appendChild(fileItem);
    });

    if (selectedFiles.length === 0) {
        document.getElementById('analyzeBtn').disabled = true;
    }
}

/**
 * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
 */
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

/**
 * å¼€å§‹åˆ†æéŸ³é¢‘
 */
async function analyzeAudio() {
    if (selectedFiles.length === 0) {
        showError('è¯·å…ˆé€‰æ‹©éŸ³é¢‘æ–‡ä»¶');
        return;
    }

    showLoading();
    hideError();

    try {
        const formData = new FormData();
        selectedFiles.forEach(file => {
            formData.append('audio_files', file);
        });

        // é»˜è®¤å¯ç”¨å¹³æ»‘ç®—æ³•ï¼ˆé¦–æ¬¡åˆ†æï¼‰
        formData.append('enable_smoothing', 'true');

        const response = await fetch('/api/analyze', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            analysisResults = result;
            displayResults(result);
            hideLoading();
            showReuploadCard();

            console.log(`åˆ†æå®Œæˆ - å¹³æ»‘ç®—æ³•çŠ¶æ€: ${result.smoothing_enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}`);
        } else {
            throw new Error(result.error || 'åˆ†æå¤±è´¥');
        }
    } catch (error) {
        console.error('åˆ†æé”™è¯¯:', error);
        showError('åˆ†æå¤±è´¥: ' + error.message);
        hideLoading();
    }
}

/**
 * æ˜¾ç¤ºåˆ†æç»“æœ
 */
function displayResults(results) {
    // éšè—ä¸Šä¼ å¡ç‰‡ï¼Œæ˜¾ç¤ºç»“æœ
    document.getElementById('uploadCard').style.display = 'none';
    document.getElementById('instructionsCard').style.display = 'none';
    document.getElementById('results').style.display = 'block';
    document.getElementById('eqConsole').style.display = 'block';
    document.getElementById('eqPlaceholder').style.display = 'none';

    // è®¾ç½®EQå»ºè®®
    if (results.eq_suggestions) {
        eq15Settings = results.eq_suggestions.eq_15.map(item =>
            parseFloat(item.adjustment.replace(/[^-\d.]/g, ''))
        );
        eq31Settings = results.eq_suggestions.eq_31.map(item =>
            parseFloat(item.adjustment.replace(/[^-\d.]/g, ''))
        );
    }

    // ç»˜åˆ¶é¢‘å“æ›²çº¿
    drawFrequencyChart(results.chart_data);

    // æ›´æ–°EQæ§åˆ¶å™¨
    updateEQDisplays();

    // æ˜¾ç¤ºé¢‘ç‡æé™
    updateFrequencyLimits(results.frequency_limits);

    // æ˜¾ç¤ºéŸ³ç®±é—®é¢˜è¯Šæ–­
    displaySpeakerIssues(results.speaker_issues);

    // æ·»åŠ ç®—æ³•é€‰æ‹©æ§ä»¶åˆ°EQåŒºåŸŸï¼ˆç°åœ¨æ˜¯å¯æŠ˜å çš„ï¼‰
    addSmoothingControlToEQAreaWithCollapse();

    // âœ… æ–°å¢ï¼šä½¿ç›®æ ‡é¢‘ç‡èŒƒå›´åŒºåŸŸå˜ä¸ºå¯æŠ˜å 
    setTimeout(() => {
        makeFrequencyRangeCollapsible();
        // åˆå§‹åŒ–æ‰€æœ‰æŠ˜å åŒºåŸŸçš„çŠ¶æ€
        initializeCollapsibleSections();
    }, 100); // å»¶è¿Ÿæ‰§è¡Œç¡®ä¿DOMå·²æ›´æ–°
}


// å¹³æ»‘ç®—æ³•æ§ä»¶åˆ°EQæ§åˆ¶åŒºåŸŸ
function addSmoothingControlToEQArea() {
    const eqConsole = document.getElementById('eqConsole');

    // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡æ§ä»¶
    if (document.getElementById('algorithmSelector')) {
        return;
    }

    // åˆ›å»ºç®—æ³•é€‰æ‹©å™¨åŒºåŸŸ - æ·»åŠ åº•éƒ¨åˆ†å‰²çº¿æ ·å¼
    const algorithmSelectorSection = document.createElement('div');
    algorithmSelectorSection.className = 'eq-section algorithm-selector-section';
    // âœ… å…³é”®ä¿®æ”¹ï¼šæ·»åŠ ä¸å…¶ä»–åŒºåŸŸä¸€è‡´çš„åˆ†å‰²çº¿æ ·å¼
    algorithmSelectorSection.style.cssText = 'border-bottom: 2px solid #e9ecef; padding-bottom: 20px; margin-bottom: 25px;';

    algorithmSelectorSection.innerHTML = `
        <h4>EQç®—æ³•é€‰æ‹©</h4>
        <div id="algorithmSelector" class="algorithm-selector">
            <div class="algorithm-option">
                <label class="algorithm-label">
                    <input type="radio" name="eqAlgorithm" value="smoothed" id="algorithmSmoothed" checked>
                    <span class="radio-checkmark"></span>
                    <div class="algorithm-info">
                        <span class="algorithm-title">å¹³æ»‘ä¼˜åŒ–ç®—æ³•</span>
                        <span class="algorithm-desc">å‡å°‘400Hzä»¥ä¸Šé¢‘æ®µå…±é¸£ï¼Œå¬æ„Ÿæ›´è‡ªç„¶ï¼ˆæ¨èï¼‰</span>
                    </div>
                </label>
            </div>
            <div class="algorithm-option">
                <label class="algorithm-label">
                    <input type="radio" name="eqAlgorithm" value="precise" id="algorithmPrecise">
                    <span class="radio-checkmark"></span>
                    <div class="algorithm-info">
                        <span class="algorithm-title">ç²¾ç¡®æ ¡æ­£ç®—æ³•</span>
                        <span class="algorithm-desc">ä¸¥æ ¼æŒ‰æµ‹é‡æ•°æ®æ ¡æ­£ï¼Œé€‚åˆä¸“ä¸šç›‘å¬</span>
                    </div>
                </label>
            </div>
        </div>
        <div class="algorithm-actions">
            <button class="btn btn-algorithm" onclick="applySelectedAlgorithm()">åº”ç”¨é€‰æ‹©çš„ç®—æ³•</button>
            <div class="algorithm-status" id="currentAlgorithmStatus">
                å½“å‰ï¼šå¹³æ»‘ä¼˜åŒ–ç®—æ³•
            </div>
        </div>
    `;

    // æ’å…¥åˆ°ç¬¬ä¸€ä¸ªeq-sectionä¹‹å‰ï¼ˆåœ¨æ•°æ®å¯¼å‡ºä¹‹åï¼‰
    const firstEQSection = eqConsole.querySelector('.eq-section:nth-child(2)'); // è·³è¿‡æ•°æ®å¯¼å‡ºéƒ¨åˆ†
    eqConsole.insertBefore(algorithmSelectorSection, firstEQSection);

    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    initializeAlgorithmSelector();
}

// åˆå§‹åŒ–ç®—æ³•é€‰æ‹©å™¨äº‹ä»¶
function initializeAlgorithmSelector() {
    const radioButtons = document.querySelectorAll('input[name="eqAlgorithm"]');

    radioButtons.forEach(radio => {
        radio.addEventListener('change', function () {
            const selectedAlgorithm = this.value;
            const statusText = selectedAlgorithm === 'smoothed' ? 'å¹³æ»‘ä¼˜åŒ–ç®—æ³•' : 'ç²¾ç¡®æ ¡æ­£ç®—æ³•';

            // æ›´æ–°çŠ¶æ€æ˜¾ç¤ºï¼ˆä½†ä¸ç«‹å³åº”ç”¨ï¼‰
            const statusElement = document.getElementById('currentAlgorithmStatus');
            statusElement.innerHTML = `é€‰æ‹©ï¼š${statusText} <span style="color: #ffc107;">ï¼ˆç‚¹å‡»"åº”ç”¨"ç”Ÿæ•ˆï¼‰</span>`;
            statusElement.className = 'algorithm-status pending';
        });
    });
}



// åº”ç”¨é€‰æ‹©çš„ç®—æ³•
async function applySelectedAlgorithm() {
    if (!analysisResults) {
        showError('è¯·å…ˆå®ŒæˆéŸ³é¢‘åˆ†æ');
        return;
    }

    const selectedRadio = document.querySelector('input[name="eqAlgorithm"]:checked');
    const useSmoothing = selectedRadio.value === 'smoothed';

    console.log(`åº”ç”¨ç®—æ³•: ${useSmoothing ? 'å¹³æ»‘ä¼˜åŒ–' : 'ç²¾ç¡®æ ¡æ­£'}`);

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const applyButton = document.querySelector('.btn-algorithm');
    const originalText = applyButton.textContent;
    applyButton.textContent = 'åº”ç”¨ä¸­...';
    applyButton.disabled = true;

    try {
        // å‡†å¤‡é‡æ–°åˆ†æçš„æ•°æ®
        const requestData = {
            frequencies: analysisResults.chart_data.frequencies,
            measured_spectrum_diff: analysisResults.chart_data.measured_spectrum_diff,
            target_low_freq: targetLowFreq,
            target_high_freq: targetHighFreq,
            enable_smoothing: useSmoothing
        };

        // è°ƒç”¨åç«¯é‡æ–°ä¼˜åŒ–API
        const response = await fetch('/api/reoptimize', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        const result = await response.json();

        if (result.success) {
            // æ›´æ–°EQè®¾ç½®
            eq15Settings = result.eq_15_settings;
            eq31Settings = result.eq_31_settings;

            // æ›´æ–°å›¾è¡¨æ•°æ®
            const updatedChartData = {
                ...analysisResults.chart_data,
                eq_15_applied_diff: result.eq_15_applied_diff,
                eq_31_applied_diff: result.eq_31_applied_diff
            };

            // é‡æ–°ç»˜åˆ¶å›¾è¡¨
            drawFrequencyChart(updatedChartData);

            // æ›´æ–°EQæ˜¾ç¤º
            updateEQDisplays();

            // æ›´æ–°é¢‘ç‡æé™
            updateFrequencyLimits(result.frequency_limits);

            // æ›´æ–°ç®—æ³•çŠ¶æ€æ˜¾ç¤º
            const algorithmName = useSmoothing ? 'å¹³æ»‘ä¼˜åŒ–ç®—æ³•' : 'ç²¾ç¡®æ ¡æ­£ç®—æ³•';
            const statusElement = document.getElementById('currentAlgorithmStatus');
            statusElement.innerHTML = `å½“å‰ï¼š${algorithmName}`;
            statusElement.className = 'algorithm-status applied';

            // å¦‚æœå½“å‰æ­£åœ¨ä½¿ç”¨EQè¿›è¡ŒéŸ³é¢‘è¯•å¬ï¼Œç«‹å³æ›´æ–°éŸ³é¢‘æ•ˆæœ
            if (currentEQType === 'eq15' || currentEQType === 'eq31') {
                updateAudioEQ();
                showEQUpdateFeedback(currentEQType);
            }

            console.log(`ç®—æ³•åº”ç”¨æˆåŠŸ: ${algorithmName}`);
            showSuccessMessage(`å·²åº”ç”¨${algorithmName}ï¼ŒEQè®¾ç½®å·²æ›´æ–°`);

        } else {
            throw new Error(result.error || 'ç®—æ³•åº”ç”¨å¤±è´¥');
        }

    } catch (error) {
        console.error('åº”ç”¨ç®—æ³•å¤±è´¥:', error);
        showError('ç®—æ³•åº”ç”¨å¤±è´¥: ' + error.message);
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        applyButton.textContent = originalText;
        applyButton.disabled = false;
    }
}




// // æ–°å¢å‡½æ•° - æ˜¾ç¤ºå¹³æ»‘ç®—æ³•çŠ¶æ€
// function displaySmoothingStatus(smoothingEnabled) {
//     // æŸ¥æ‰¾æˆ–åˆ›å»ºçŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ
//     let statusContainer = document.getElementById('algorithmStatus');

//     if (!statusContainer) {
//         // åˆ›å»ºçŠ¶æ€å®¹å™¨
//         statusContainer = document.createElement('div');
//         statusContainer.id = 'algorithmStatus';
//         statusContainer.className = 'algorithm-status-container';

//         // æ’å…¥åˆ°æ•°æ®å¯¼å‡ºéƒ¨åˆ†ä¹‹å‰
//         const eqConsole = document.getElementById('eqConsole');
//         const firstSection = eqConsole.querySelector('.eq-section');
//         eqConsole.insertBefore(statusContainer, firstSection);
//     }

//     // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
//     const statusClass = smoothingEnabled ? 'enabled' : 'disabled';
//     const statusIcon = smoothingEnabled ? 'âœ“' : 'âœ—';
//     const statusText = smoothingEnabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
//     const statusDescription = smoothingEnabled ?
//         'å·²ä¼˜åŒ–ä¸­é«˜é¢‘åŒºåŸŸï¼Œå‡å°‘å…±é¸£é—®é¢˜' :
//         'ç²¾ç¡®æ ¡æ­£æ¨¡å¼ï¼Œæœªåº”ç”¨å¹³æ»‘å¤„ç†';

//     statusContainer.innerHTML = `
//         <div class="eq-section algorithm-status-section">
//             <h4>ç®—æ³•çŠ¶æ€</h4>
//             <div class="algorithm-status ${statusClass}">
//                 <div class="status-indicator">
//                     <span class="status-icon">${statusIcon}</span>
//                     <span class="status-text">ä¸­é«˜é¢‘å¹³æ»‘ä¼˜åŒ–: ${statusText}</span>
//                 </div>
//                 <div class="status-description">
//                     <small>${statusDescription}</small>
//                 </div>
//             </div>
//         </div>
//     `;
// }

// // æ·»åŠ å¹³æ»‘ç®—æ³•æ§ä»¶åˆ°ä¸Šä¼ å¡ç‰‡ä¸­
// function addSmoothingControlToUploadCard() {
//     const uploadCard = document.getElementById('uploadCard');
//     const cardBody = uploadCard.querySelector('.card-body');

//     // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡æ§ä»¶
//     if (document.getElementById('enableSmoothing')) {
//         return;
//     }

//     // åˆ›å»ºå¹³æ»‘ç®—æ³•æ§åˆ¶ç»„
//     const smoothingControlGroup = document.createElement('div');
//     smoothingControlGroup.className = 'smoothing-control-group';
//     smoothingControlGroup.innerHTML = `
//         <div class="smoothing-control">
//             <label class="smoothing-label">
//                 <input type="checkbox" id="enableSmoothing" checked>
//                 <span class="checkmark"></span>
//                 <span class="control-text">å¯ç”¨ä¸­é«˜é¢‘å¹³æ»‘ä¼˜åŒ–</span>
//                 <span class="control-info" title="æ¨èå¯ç”¨ï¼šå‡å°‘400Hzä»¥ä¸Šé¢‘æ®µçš„å…±é¸£é—®é¢˜ï¼Œè·å¾—æ›´è‡ªç„¶çš„å¬æ„Ÿã€‚ä¸“ä¸šç”¨æˆ·å¯å…³é—­ä»¥è·å¾—ç²¾ç¡®æ ¡æ­£ã€‚">â„¹ï¸</span>
//             </label>
//             <div class="control-description">
//                 <small>400Hzä»¥ä¸Šé¢‘æ®µé‡‡ç”¨å¹³æ»‘å¤„ç†ï¼Œé¿å…è¿‡åº¦æ ¡æ­£é€ æˆçš„å…±é¸£é—®é¢˜</small>
//             </div>
//         </div>
//     `;

//     // æ’å…¥åˆ°åˆ†ææŒ‰é’®å‰é¢
//     const analyzeButtonContainer = cardBody.querySelector('div[style*="text-align: center"]');
//     cardBody.insertBefore(smoothingControlGroup, analyzeButtonContainer);
// }

/**
 * ç»˜åˆ¶é¢‘å“æ›²çº¿å›¾è¡¨
 */
function drawFrequencyChart(chartData) {
    const svg = document.getElementById('frequencyChart');
    const width = 800;
    const height = 400;
    const margin = { top: 20, right: 40, bottom: 60, left: 60 };
    const chartWidth = width - margin.left - margin.right;
    const chartHeight = height - margin.top - margin.bottom;

    // æ¸…ç©ºç°æœ‰å†…å®¹
    svg.innerHTML = '';

    // é¢‘ç‡å’Œå¹…åº¦èŒƒå›´
    // é¢‘ç‡å’Œå¹…åº¦èŒƒå›´ - è‡ªé€‚åº”çºµåæ ‡ç¼©æ”¾
    const freqs = chartData.frequencies;
    const minFreq = Math.min(...freqs);
    const maxFreq = Math.max(...freqs);

    // æ”¶é›†æ‰€æœ‰éœ€è¦æ˜¾ç¤ºçš„æ›²çº¿æ•°æ®
    const allData = [];
    if (curveVisibility.original && chartData.measured_spectrum_diff) {
        allData.push(...chartData.measured_spectrum_diff.filter(val => !isNaN(val) && isFinite(val)));
    }
    if (curveVisibility.eq15 && chartData.eq_15_applied_diff) {
        allData.push(...chartData.eq_15_applied_diff.filter(val => !isNaN(val) && isFinite(val)));
    }
    if (curveVisibility.eq31 && chartData.eq_31_applied_diff) {
        allData.push(...chartData.eq_31_applied_diff.filter(val => !isNaN(val) && isFinite(val)));
    }

    // è‡ªé€‚åº”è®¡ç®—Yè½´èŒƒå›´ - æ”¹è¿›ç®—æ³•
    let minDb, maxDb;
    if (allData.length > 0) {
        // è¿‡æ»¤å¼‚å¸¸å€¼ï¼ˆè¶…è¿‡Â±100dBçš„å€¼é€šå¸¸æ˜¯é”™è¯¯æ•°æ®ï¼‰
        const validData = allData.filter(val => val >= -100 && val <= 100);

        if (validData.length > 0) {
            const dataMin = Math.min(...validData);
            const dataMax = Math.max(...validData);

            // è®¡ç®—åˆç†çš„è¾¹è·ï¼Œè‡³å°‘3dB
            const range = dataMax - dataMin;
            const padding = Math.max(3, range * 0.15); // 15%è¾¹è·ï¼Œæœ€å°‘3dB

            // æ‰©å±•èŒƒå›´å¹¶å¯¹é½åˆ°3dBç½‘æ ¼
            const expandedMin = dataMin - padding;
            const expandedMax = dataMax + padding;

            minDb = Math.floor(expandedMin / 3) * 3;
            maxDb = Math.ceil(expandedMax / 3) * 3;

            // ç¡®ä¿æœ€å°æ˜¾ç¤ºèŒƒå›´ä¸º18dB
            if (maxDb - minDb < 18) {
                const center = (maxDb + minDb) / 2;
                minDb = center - 9;
                maxDb = center + 9;
                // é‡æ–°å¯¹é½åˆ°3dBç½‘æ ¼
                minDb = Math.floor(minDb / 3) * 3;
                maxDb = Math.ceil(maxDb / 3) * 3;
            }

            // console.log(`æ•°æ®èŒƒå›´: ${dataMin.toFixed(1)}dB åˆ° ${dataMax.toFixed(1)}dB`);
            // console.log(`æ˜¾ç¤ºèŒƒå›´: ${minDb}dB åˆ° ${maxDb}dB`);
        } else {
            // æ²¡æœ‰æœ‰æ•ˆæ•°æ®æ—¶ä½¿ç”¨é»˜è®¤èŒƒå›´
            minDb = -15;
            maxDb = 15;
        }
    } else {
        // æ²¡æœ‰æ•°æ®æ—¶ä½¿ç”¨é»˜è®¤èŒƒå›´
        minDb = -15;
        maxDb = 15;
    }

    // åˆ›å»ºæ¯”ä¾‹å°º
    const xScale = (freq) => margin.left + chartWidth * Math.log10(freq / minFreq) / Math.log10(maxFreq / minFreq);
    const yScale = (db) => margin.top + chartHeight * (maxDb - db) / (maxDb - minDb);

    // ç»˜åˆ¶ç½‘æ ¼
    drawGrid();

    // ç»˜åˆ¶åæ ‡è½´
    drawAxes();

    // ç»˜åˆ¶æ›²çº¿
    drawCurves();

    function drawGrid() {
        const gridGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        gridGroup.setAttribute('class', 'grid');

        // é¢‘ç‡ç½‘æ ¼çº¿
        const freqLines = [20, 30, 50, 70, 100, 150, 200, 300, 500, 700, 1000, 1500, 2000, 3000, 5000, 7000, 10000, 15000, 20000];
        freqLines.forEach(freq => {
            if (freq >= minFreq && freq <= maxFreq) {
                const x = xScale(freq);
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x);
                line.setAttribute('y1', margin.top);
                line.setAttribute('x2', x);
                line.setAttribute('y2', height - margin.bottom);
                line.setAttribute('stroke', '#e0e0e0');
                line.setAttribute('stroke-width', '1');
                gridGroup.appendChild(line);
            }
        });

        // åˆ†è´ç½‘æ ¼çº¿ - è‡ªé€‚åº”é—´éš”
        const dbRange = maxDb - minDb;
        let dbStep = 1.5; // é»˜è®¤1.5dBé—´éš”

        // æ ¹æ®èŒƒå›´è°ƒæ•´ç½‘æ ¼å¯†åº¦
        if (dbRange > 40) {
            dbStep = 6; // å¤§èŒƒå›´æ—¶ä½¿ç”¨6dBé—´éš”
        } else if (dbRange > 15) {
            dbStep = 3;  // ä¸­ç­‰èŒƒå›´æ—¶ä½¿ç”¨3dBé—´éš”
        }

        // è®¡ç®—èµ·å§‹ç‚¹ï¼Œç¡®ä¿åŒ…å«0dBçº¿
        const startDb = Math.floor(minDb / dbStep) * dbStep;
        const endDb = Math.ceil(maxDb / dbStep) * dbStep;

        for (let db = startDb; db <= endDb; db += dbStep) {
            if (db >= minDb && db <= maxDb) {
                const y = yScale(db);
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', margin.left);
                line.setAttribute('y1', y);
                line.setAttribute('x2', width - margin.right);
                line.setAttribute('y2', y);
                line.setAttribute('stroke', db === 0 ? '#999' : '#e0e0e0');
                line.setAttribute('stroke-width', db === 0 ? '2' : '1');
                gridGroup.appendChild(line);
            }
        }

        svg.appendChild(gridGroup);
    }

    function drawAxes() {
        // Xè½´
        const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        xAxis.setAttribute('x1', margin.left);
        xAxis.setAttribute('y1', height - margin.bottom);
        xAxis.setAttribute('x2', width - margin.right);
        xAxis.setAttribute('y2', height - margin.bottom);
        xAxis.setAttribute('stroke', '#333');
        xAxis.setAttribute('stroke-width', '2');
        svg.appendChild(xAxis);

        // Yè½´
        const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        yAxis.setAttribute('x1', margin.left);
        yAxis.setAttribute('y1', margin.top);
        yAxis.setAttribute('x2', margin.left);
        yAxis.setAttribute('y2', height - margin.bottom);
        yAxis.setAttribute('stroke', '#333');
        yAxis.setAttribute('stroke-width', '2');
        svg.appendChild(yAxis);

        // é¢‘ç‡æ ‡ç­¾
        const freqLabels = [20, 30, 50, 70, 100, 150, 200, 300, 500, 700, 1000, 1500, 2000, 3000, 5000, 7000, 10000, 15000, 20000];
        freqLabels.forEach(freq => {
            if (freq >= Math.min(minFreq, 20) && freq <= maxFreq) {
                const x = xScale(freq);
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', x);
                text.setAttribute('y', height - margin.bottom + 20);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('font-size', '12');
                text.setAttribute('fill', '#666');
                text.textContent = freq >= 1000 ? (freq / 1000) + 'k' : freq;
                svg.appendChild(text);
            }
        });

        // åˆ†è´æ ‡ç­¾ - è‡ªé€‚åº”æ ‡ç­¾é—´éš”
        const dbRange = maxDb - minDb;
        let labelStep = 3; // é»˜è®¤3dBé—´éš”

        // æ ¹æ®èŒƒå›´è°ƒæ•´æ ‡ç­¾å¯†åº¦  
        if (dbRange > 40) {
            labelStep = 6; // å¤§èŒƒå›´æ—¶ä½¿ç”¨6dBé—´éš”
        } else if (dbRange > 15) {
            labelStep = 3;  // ä¸­ç­‰èŒƒå›´æ—¶ä½¿ç”¨3dBé—´éš”
        } else if (dbRange < 15) {
            labelStep = 1.5;  // å°èŒƒå›´æ—¶ä½¿ç”¨1.5dBé—´éš”
        }

        const startLabelDb = Math.floor(minDb / labelStep) * labelStep;
        const endLabelDb = Math.ceil(maxDb / labelStep) * labelStep;

        for (let db = startLabelDb; db <= endLabelDb; db += labelStep) {
            if (db >= minDb && db <= maxDb) {
                const y = yScale(db);
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', margin.left - 10);
                text.setAttribute('y', y + 4);
                text.setAttribute('text-anchor', 'end');
                text.setAttribute('font-size', '12');
                text.setAttribute('fill', '#666');
                text.textContent = db + 'dB';
                svg.appendChild(text);
            }
        }

        // è½´æ ‡ç­¾
        const xLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        xLabel.setAttribute('x', width / 2);
        xLabel.setAttribute('y', height - 10);
        xLabel.setAttribute('text-anchor', 'middle');
        xLabel.setAttribute('font-size', '14');
        xLabel.setAttribute('fill', '#333');
        xLabel.textContent = 'é¢‘ç‡ (Hz)';
        svg.appendChild(xLabel);

        const yLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        yLabel.setAttribute('x', 20);
        yLabel.setAttribute('y', height / 2 - 10);
        yLabel.setAttribute('text-anchor', 'middle');
        yLabel.setAttribute('font-size', '14');
        yLabel.setAttribute('fill', '#333');
        yLabel.setAttribute('transform', `rotate(-90, 20, ${height / 2})`);
        yLabel.textContent = 'é¢‘å“åå·® (dB)';
        svg.appendChild(yLabel);

        // åŸç‚¹æ ‡æ³¨
        const originX = margin.left;
        const originY = height - margin.bottom;

        // // é¢‘ç‡åŸç‚¹æ ‡æ³¨ (20Hz)
        // const freqOriginText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        // freqOriginText.setAttribute('x', originX - 5);
        // freqOriginText.setAttribute('y', originY + 35);
        // freqOriginText.setAttribute('text-anchor', 'end');
        // freqOriginText.setAttribute('font-size', '11');
        // freqOriginText.setAttribute('fill', '#333');
        // freqOriginText.setAttribute('font-weight', 'bold');
        // freqOriginText.textContent = '20Hz';
        // svg.appendChild(freqOriginText);

        // // åˆ†è´åŸç‚¹æ ‡æ³¨ (0dBå‚è€ƒçº¿ä½ç½®)
        // const zeroDbY = yScale(0);
        // const dbOriginText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        // dbOriginText.setAttribute('x', originX - 15);
        // dbOriginText.setAttribute('y', zeroDbY + 4);
        // dbOriginText.setAttribute('text-anchor', 'end');
        // dbOriginText.setAttribute('font-size', '11');
        // dbOriginText.setAttribute('fill', '#333');
        // dbOriginText.setAttribute('font-weight', 'bold');
        // dbOriginText.textContent = '0dB';
        // svg.appendChild(dbOriginText);
    }

    function drawCurves() {
        const curves = [
            {
                id: 'original',
                data: chartData.measured_spectrum_diff,
                color: '#e57373',
                label: 'åŸå§‹æµ‹é‡',
                visible: curveVisibility.original
            },
            {
                id: 'eq15',
                data: chartData.eq_15_applied_diff,
                color: '#81c784',
                label: '15æ®µEQåé¢„æµ‹',
                visible: curveVisibility.eq15
            },
            {
                id: 'eq31',
                data: chartData.eq_31_applied_diff,
                color: '#64b5f6',
                label: '31æ®µEQåé¢„æµ‹',
                visible: curveVisibility.eq31
            }
        ];

        curves.forEach(curve => {
            if (!curve.visible || !curve.data) return;

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            let pathData = '';
            let validPointsCount = 0;

            // éªŒè¯æ•°æ®å¹¶æ„å»ºè·¯å¾„
            curve.data.forEach((db, i) => {
                // æ·»åŠ æ•°æ®éªŒè¯
                if (!isFinite(db) || !isFinite(freqs[i]) || freqs[i] <= 0) {
                    console.warn(`è·³è¿‡æ— æ•ˆæ•°æ®ç‚¹: freq=${freqs[i]}, db=${db}`);
                    return;
                }

                const x = xScale(freqs[i]);
                const y = yScale(db);

                // éªŒè¯è®¡ç®—ç»“æœ
                if (!isFinite(x) || !isFinite(y)) {
                    console.warn(`è·³è¿‡æ— æ•ˆåæ ‡: x=${x}, y=${y}`);
                    return;
                }

                if (validPointsCount === 0) {
                    pathData += `M ${x} ${y}`;
                } else {
                    pathData += ` L ${x} ${y}`;
                }
                validPointsCount++;
            });

            // åªæœ‰åœ¨æœ‰æœ‰æ•ˆæ•°æ®ç‚¹æ—¶æ‰ç»˜åˆ¶è·¯å¾„
            if (validPointsCount > 0 && pathData) {
                path.setAttribute('d', pathData);
                path.setAttribute('stroke', curve.color);
                path.setAttribute('stroke-width', '2');
                path.setAttribute('fill', 'none');
                path.setAttribute('data-curve', curve.id);
                svg.appendChild(path);
            } else {
                console.warn(`æ›²çº¿ ${curve.id} æ²¡æœ‰æœ‰æ•ˆæ•°æ®ç‚¹`);
            }
        });
    }

    // ä¿å­˜å›¾è¡¨å¼•ç”¨
    currentChart = { chartData, xScale, yScale };
}

/**
 * åˆå§‹åŒ–EQæ§åˆ¶å™¨
 */
function initializeEQControls() {
    updateEQDisplays();
}

/**
 * æ›´æ–°EQæ˜¾ç¤º
 */
function updateEQDisplays() {
    updateEQDisplay('15', eq15Settings, eq15PageIndex);
    updateEQDisplay('31', eq31Settings, eq31PageIndex);
    updatePageInfo();
}

/**
 * æ›´æ–°å•ä¸ªEQæ˜¾ç¤º
 */
function updateEQDisplay(eqType, settings, pageIndex) {
    const container = document.getElementById(`eq${eqType}Channels`);
    const perPage = eqType === '15' ? eq15PerPage : eq31PerPage;
    const freqs = eqType === '15' ?
        [25, 40, 63, 100, 160, 250, 400, 630, 1000, 1600, 2500, 4000, 6300, 10000, 16000] :
        [20, 25, 31.5, 40, 50, 63, 80, 100, 125, 160, 200, 250, 315, 400, 500,
            630, 800, 1000, 1250, 1600, 2000, 2500, 3150, 4000, 5000, 6300,
            8000, 10000, 12500, 16000, 20000];

    container.innerHTML = '';

    const startIndex = pageIndex * perPage;
    const endIndex = Math.min(startIndex + perPage, settings.length);

    for (let i = startIndex; i < endIndex; i++) {
        const freq = freqs[i];
        const value = settings[i];

        const channel = document.createElement('div');
        channel.className = 'eq-channel';

        channel.innerHTML = `
            <div class="eq-frequency-label">${formatFrequency(freq)}</div>
            <div class="eq-slider-container" onclick="handleEQClick(event, '${eqType}', ${i})">
                <div class="eq-slider-track"></div>
                <div class="eq-slider-center"></div>
                <div class="eq-slider-handle ${value > 0 ? 'positive' : value < 0 ? 'negative' : ''}"
                    style="top: ${(12 - value) / 24 * 156 / 180 * 100}%"
                    onmousedown="startEQDrag(event, '${eqType}', ${i})"></div>
            </div>
            <div class="eq-value-label ${value > 0 ? 'positive' : value < 0 ? 'negative' : ''}"
                 ondblclick="editEQValue('${eqType}', ${i})">${value.toFixed(1)}dB</div>
        `;

        container.appendChild(channel);
    }
}

/**
 * æ ¼å¼åŒ–é¢‘ç‡æ˜¾ç¤º
 */
function formatFrequency(freq) {
    if (freq >= 1000) {
        return (freq / 1000).toString().replace('.', '.') + 'k';
    }
    return freq.toString();
}

/**
 * å¤„ç†EQç‚¹å‡»
 */
function handleEQClick(event, eqType, index) {
    event.preventDefault();
    const container = event.currentTarget;
    const rect = container.getBoundingClientRect();
    const y = event.clientY - rect.top;
    const percentage = Math.max(0, Math.min(100, (y / rect.height) * 100));
    const value = Math.max(-12, Math.min(12, (50 - percentage) * 12 / 40));

    setEQValue(eqType, index, value);
}

/**
 * å¼€å§‹EQæ‹–æ‹½
 */
function startEQDrag(event, eqType, index) {
    event.preventDefault();
    event.stopPropagation();

    const startY = event.clientY;
    const container = event.currentTarget.parentElement;
    const rect = container.getBoundingClientRect();
    const startValue = eqType === '15' ? eq15Settings[index] : eq31Settings[index];

    function onMouseMove(e) {
        const deltaY = e.clientY - startY;
        const valueChange = -(deltaY / rect.height) * 24; // 24dB æ€»èŒƒå›´
        const newValue = Math.max(-12, Math.min(12, startValue + valueChange));
        setEQValue(eqType, index, newValue);
    }

    function onMouseUp() {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
    }

    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
}

/**
 * å½“EQè®¾ç½®æ›´æ”¹æ—¶ï¼Œä¹Ÿè¦æ›´æ–°éŸ³é¢‘EQ
 */
function setEQValue(eqType, index, value) {
    value = Math.round(value * 10) / 10; // ä¿ç•™1ä½å°æ•°

    if (eqType === '15') {
        eq15Settings[index] = value;
    } else {
        eq31Settings[index] = value;
    }

    updateEQDisplays();
    updatePredictedCurves();

    // å¦‚æœå½“å‰æ­£åœ¨ä½¿ç”¨è¿™ä¸ªEQç±»å‹ï¼Œç«‹å³æ›´æ–°éŸ³é¢‘æ•ˆæœ
    if ((eqType === '15' && currentEQType === 'eq15') ||
        (eqType === '31' && currentEQType === 'eq31')) {
        updateAudioEQ();
    }
}

/**
 * ç¼–è¾‘EQå€¼
 */
function editEQValue(eqType, index) {
    const currentValue = eqType === '15' ? eq15Settings[index] : eq31Settings[index];
    const newValue = prompt('è¾“å…¥EQå€¼ (-12åˆ°+12):', currentValue.toFixed(1));

    if (newValue !== null) {
        const value = parseFloat(newValue);
        if (!isNaN(value)) {
            setEQValue(eqType, index, Math.max(-12, Math.min(12, value)));
        }
    }
}

/**
 * æ›´æ–°é¢„æµ‹æ›²çº¿
 */
function updatePredictedCurves() {
    if (!analysisResults || !currentChart) return;

    // é‡æ–°è®¡ç®—EQåº”ç”¨åçš„æ›²çº¿
    const originalData = analysisResults.chart_data.measured_spectrum_diff;
    const frequencies = analysisResults.chart_data.frequencies;

    // è®¡ç®—15æ®µEQæ•ˆæœ
    const eq15Applied = applyEQToCurve(frequencies, originalData, eq15Settings, '15');

    // è®¡ç®—31æ®µEQæ•ˆæœ
    const eq31Applied = applyEQToCurve(frequencies, originalData, eq31Settings, '31');

    // æ›´æ–°å›¾è¡¨æ•°æ®
    const updatedChartData = {
        ...analysisResults.chart_data,
        eq_15_applied_diff: eq15Applied,
        eq_31_applied_diff: eq31Applied
    };

    // é‡æ–°ç»˜åˆ¶å›¾è¡¨
    drawFrequencyChart(updatedChartData);

    // æ›´æ–°é¢‘ç‡æé™
    updatePredictedFrequencyLimits(frequencies, eq15Applied, eq31Applied);
}

/**
 * æœ€ç»ˆä¿®å¤ç‰ˆï¼šæ ‡å‡†Web Audio APIåŒäºŒé˜¶å³°å€¼æ»¤æ³¢å™¨
 * ä½¿ç”¨ç»Ÿä¸€çš„ç³»æ•°è®¡ç®—å…¬å¼ï¼Œæ­£ç¡®å¤„ç†æ­£è´Ÿå¢ç›Š
 */
function calculateBiquadPeakingResponse(frequency, centerFreq, Q, gainDb) {
    // åŸºç¡€éªŒè¯
    if (!isFinite(frequency) || !isFinite(centerFreq) || !isFinite(Q) || !isFinite(gainDb)) {
        return 0;
    }

    if (frequency <= 0 || centerFreq <= 0 || Q <= 0.01) {
        return 0;
    }

    // é™åˆ¶å¢ç›ŠèŒƒå›´
    gainDb = Math.max(-60, Math.min(60, gainDb));

    // å¦‚æœå¢ç›Šå¾ˆå°ï¼Œç›´æ¥è¿”å›0
    if (Math.abs(gainDb) < 0.01) {
        return 0;
    }

    try {
        // Web Audio APIæ ‡å‡†å®ç°
        const A = Math.pow(10, gainDb / 40);  // å¹…åº¦å¢ç›Šå› å­

        // å‡è®¾é‡‡æ ·ç‡44.1kHz
        const sampleRate = 44100;
        const w0 = 2 * Math.PI * centerFreq / sampleRate;  // ä¸­å¿ƒé¢‘ç‡çš„å½’ä¸€åŒ–è§’é¢‘ç‡
        const cos_w0 = Math.cos(w0);
        const sin_w0 = Math.sin(w0);
        const alpha = sin_w0 / (2 * Q);

        // éªŒè¯ä¸­é—´å‚æ•°
        if (!isFinite(A) || !isFinite(w0) || !isFinite(alpha)) {
            return 0;
        }

        // æ ‡å‡†å³°å€¼æ»¤æ³¢å™¨ç³»æ•° - ç»Ÿä¸€å…¬å¼
        const b0 = 1 + alpha * A;
        const b1 = -2 * cos_w0;
        const b2 = 1 - alpha * A;
        const a0 = 1 + alpha / A;
        const a1 = -2 * cos_w0;
        const a2 = 1 - alpha / A;

        // éªŒè¯ç³»æ•°
        if (!isFinite(b0) || !isFinite(b1) || !isFinite(b2) ||
            !isFinite(a0) || !isFinite(a1) || !isFinite(a2) || Math.abs(a0) < 1e-10) {
            return 0;
        }

        // å½’ä¸€åŒ–ç³»æ•°
        const norm_b0 = b0 / a0;
        const norm_b1 = b1 / a0;
        const norm_b2 = b2 / a0;
        const norm_a1 = a1 / a0;
        const norm_a2 = a2 / a0;

        // è®¡ç®—ç›®æ ‡é¢‘ç‡çš„é¢‘ç‡å“åº”
        const w = 2 * Math.PI * frequency / sampleRate;  // ç›®æ ‡é¢‘ç‡çš„å½’ä¸€åŒ–è§’é¢‘ç‡
        const cos_w = Math.cos(w);
        const sin_w = Math.sin(w);

        // éªŒè¯ç›®æ ‡é¢‘ç‡å‚æ•°
        if (!isFinite(w) || !isFinite(cos_w) || !isFinite(sin_w)) {
            return 0;
        }

        // ä½¿ç”¨å¤æ•°å½¢å¼è®¡ç®—é¢‘ç‡å“åº”
        // H(e^jw) = (b0 + b1*e^-jw + b2*e^-j2w) / (1 + a1*e^-jw + a2*e^-j2w)

        // åˆ†å­ï¼šB(e^jw) = b0 + b1*cos(w) + b2*cos(2w) + j*(-b1*sin(w) - b2*sin(2w))
        const numerator_real = norm_b0 + norm_b1 * cos_w + norm_b2 * Math.cos(2 * w);
        const numerator_imag = -norm_b1 * sin_w - norm_b2 * Math.sin(2 * w);

        // åˆ†æ¯ï¼šA(e^jw) = 1 + a1*cos(w) + a2*cos(2w) + j*(-a1*sin(w) - a2*sin(2w))
        const denominator_real = 1 + norm_a1 * cos_w + norm_a2 * Math.cos(2 * w);
        const denominator_imag = -norm_a1 * sin_w - norm_a2 * Math.sin(2 * w);

        // éªŒè¯å¤æ•°éƒ¨åˆ†
        if (!isFinite(numerator_real) || !isFinite(numerator_imag) ||
            !isFinite(denominator_real) || !isFinite(denominator_imag)) {
            return 0;
        }

        // è®¡ç®—å¹…åº¦ |H(e^jw)| = |B(e^jw)| / |A(e^jw)|
        const numerator_magnitude = Math.sqrt(numerator_real * numerator_real + numerator_imag * numerator_imag);
        const denominator_magnitude = Math.sqrt(denominator_real * denominator_real + denominator_imag * denominator_imag);

        // éªŒè¯å¹…åº¦
        if (!isFinite(numerator_magnitude) || !isFinite(denominator_magnitude) ||
            denominator_magnitude <= 0 || numerator_magnitude <= 0) {
            return 0;
        }

        const magnitude = numerator_magnitude / denominator_magnitude;

        if (!isFinite(magnitude) || magnitude <= 0) {
            return 0;
        }

        // è½¬æ¢ä¸ºdB
        const responseDb = 20 * Math.log10(magnitude);

        if (!isFinite(responseDb)) {
            return 0;
        }

        // è¿”å›ç»“æœ
        return Math.max(-60, Math.min(60, responseDb));

    } catch (error) {
        console.warn('æ»¤æ³¢å™¨å“åº”è®¡ç®—é”™è¯¯:', error);
        return 0;
    }
}

/**
 * ä¿®å¤ç‰ˆï¼šæ”¹è¿›çš„EQæ›²çº¿è®¡ç®—
 * æ·»åŠ äº†å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ•°æ®éªŒè¯
 */
function applyEQToCurve(frequencies, originalCurve, eqSettings, eqType) {
    // è¾“å…¥éªŒè¯
    if (!frequencies || !originalCurve || !eqSettings || !eqType) {
        console.error('applyEQToCurve: æ— æ•ˆçš„è¾“å…¥å‚æ•°');
        return originalCurve || [];
    }

    if (frequencies.length !== originalCurve.length) {
        console.error('applyEQToCurve: é¢‘ç‡æ•°ç»„å’Œæ›²çº¿æ•°ç»„é•¿åº¦ä¸åŒ¹é…');
        return originalCurve;
    }

    const eqFreqs = eqType === '15' ?
        [25, 40, 63, 100, 160, 250, 400, 630, 1000, 1600, 2500, 4000, 6300, 10000, 16000] :
        [20, 25, 31.5, 40, 50, 63, 80, 100, 125, 160, 200, 250, 315, 400, 500,
            630, 800, 1000, 1250, 1600, 2000, 2500, 3150, 4000, 5000, 6300,
            8000, 10000, 12500, 16000, 20000];

    const qFactor = eqType === '15' ? 2.15 : 4.31;

    try {
        return originalCurve.map((originalValue, i) => {
            // éªŒè¯è¾“å…¥å€¼
            if (!isFinite(originalValue)) {
                console.warn(`æ— æ•ˆçš„åŸå§‹å€¼åœ¨ç´¢å¼• ${i}: ${originalValue}`);
                return 0;
            }

            const freq = frequencies[i];
            if (!isFinite(freq) || freq <= 0) {
                console.warn(`æ— æ•ˆçš„é¢‘ç‡åœ¨ç´¢å¼• ${i}: ${freq}`);
                return originalValue;
            }

            let cascadedMagnitude = 1.0; // çº¿æ€§åŸŸçš„çº§è”å¹…åº¦

            // è®¡ç®—æ‰€æœ‰æœ‰æ•ˆæ»¤æ³¢å™¨çš„ä¸²è”æ•ˆæœ
            eqFreqs.forEach((eqFreq, eqIndex) => {
                if (eqIndex >= eqSettings.length) return;

                const gain = eqSettings[eqIndex];
                if (!isFinite(gain)) {
                    console.warn(`æ— æ•ˆçš„EQå¢ç›Šåœ¨ç´¢å¼• ${eqIndex}: ${gain}`);
                    return;
                }

                if (Math.abs(gain) >= 0.1) { // åªè®¡ç®—æœ‰æ˜¾è‘—å¢ç›Šçš„æ»¤æ³¢å™¨
                    const responseDb = calculateBiquadPeakingResponse(freq, eqFreq, qFactor, gain);

                    if (isFinite(responseDb)) {
                        const responseMagnitude = Math.pow(10, responseDb / 20);

                        if (isFinite(responseMagnitude) && responseMagnitude > 0) {
                            cascadedMagnitude *= responseMagnitude;
                        }
                    }
                }
            });

            // éªŒè¯çº§è”ç»“æœ
            if (!isFinite(cascadedMagnitude) || cascadedMagnitude <= 0) {
                console.warn(`æ— æ•ˆçš„çº§è”å¹…åº¦åœ¨é¢‘ç‡ ${freq}Hz: ${cascadedMagnitude}`);
                return originalValue;
            }

            const totalResponseDb = 20 * Math.log10(cascadedMagnitude);

            if (!isFinite(totalResponseDb)) {
                console.warn(`æ— æ•ˆçš„å“åº”åœ¨é¢‘ç‡ ${freq}Hz: ${totalResponseDb}`);
                return originalValue;
            }

            const result = originalValue + totalResponseDb;

            // æœ€ç»ˆéªŒè¯
            if (!isFinite(result)) {
                console.warn(`æœ€ç»ˆç»“æœæ— æ•ˆåœ¨é¢‘ç‡ ${freq}Hz: ${result}`);
                return originalValue;
            }

            return result;
        });

    } catch (error) {
        console.error('EQæ›²çº¿è®¡ç®—é”™è¯¯:', error);
        return originalCurve;
    }
}

/**
 * æ›´æ–°é¢„æµ‹é¢‘ç‡æé™
 */
function updatePredictedFrequencyLimits(frequencies, eq15Applied, eq31Applied) {
    const eq15Limits = calculateFrequencyLimits(frequencies, eq15Applied);
    const eq31Limits = calculateFrequencyLimits(frequencies, eq31Applied);

    const limits = {
        eq_15: eq15Limits,
        eq_31: eq31Limits
    };

    updateFrequencyLimits(limits);
}

function calculateFrequencyLimits(frequencies, spectrum) {
    // åŸºç¡€è°ƒè¯•ï¼šå‡½æ•°è°ƒç”¨ä¸è¾“å…¥éªŒè¯
    // console.log("[é¢‘ç‡æé™è®¡ç®—] å¼€å§‹æ‰§è¡Œ");

    // è¾“å…¥éªŒè¯
    if (!frequencies || !spectrum || frequencies.length !== spectrum.length) {
        // console.error("[é¢‘ç‡æé™è®¡ç®—] é”™è¯¯ï¼šè¾“å…¥æ•°ç»„æ— æ•ˆæˆ–é•¿åº¦ä¸åŒ¹é…");
        return { low: null, high: null };
    }

    // 1. ç¡®å®š1kHzå‚è€ƒç‚¹å’Œé˜ˆå€¼
    const refFrequency = 1000;
    const refIndex = frequencies.findIndex(f => f >= refFrequency);
    if (refIndex === -1) {
        // console.error("[é¢‘ç‡æé™è®¡ç®—] é”™è¯¯ï¼šæœªæ‰¾åˆ°1kHzåŠä»¥ä¸Šå‚è€ƒç‚¹");
        return { low: null, high: null };
    }

    const refLevel = spectrum[refIndex];
    const threshold = refLevel - 6;
    // console.log(`[é¢‘ç‡æé™è®¡ç®—] å‚è€ƒç‚¹ï¼š${frequencies[refIndex]}Hzï¼ˆ${refLevel.toFixed(2)}dBï¼‰ï¼Œ-6dBé˜ˆå€¼ï¼š${threshold.toFixed(2)}dB`);

    // 2. è®¡ç®—ä½é¢‘æé™ï¼ˆç®€åŒ–æ—¥å¿—ï¼‰
    let lowLimit = null;
    for (let i = 0; i < frequencies.length; i++) {
        const currentFreq = frequencies[i];
        if (currentFreq >= refFrequency) break; // åªå¤„ç†1kHzä»¥ä¸‹

        const currentLevel = spectrum[i];
        // æ¡ä»¶1ï¼šé«˜äºé˜ˆå€¼
        if (currentLevel < threshold) continue;

        // æ¡ä»¶2ï¼šå·¦ä¾§æ‰€æœ‰ç‚¹å‡æ›´ä½
        let isLeftAllLower = true;
        for (let j = 0; j < i; j++) {
            if (spectrum[j] >= currentLevel) {
                isLeftAllLower = false;
                break;
            }
        }

        if (isLeftAllLower) {
            lowLimit = currentFreq;
            // console.log(`[é¢‘ç‡æé™è®¡ç®—] ä½é¢‘æé™ç¡®å®šï¼š${lowLimit}Hzï¼ˆæ»¡è¶³å·¦ä¾§å…¨ä½ä¸”é«˜äºé˜ˆå€¼ï¼‰`);
            break;
        }
    }

    if (!lowLimit) {
        // console.log("[é¢‘ç‡æé™è®¡ç®—] æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ä½é¢‘æé™ç‚¹");
    }

    // 3. è®¡ç®—é«˜é¢‘æé™ï¼ˆç®€åŒ–æ—¥å¿—ï¼‰
    let highLimit = null;
    for (let i = refIndex; i < frequencies.length; i++) {
        if (spectrum[i] < threshold) {
            highLimit = i > 0 ? frequencies[i - 1] : null;
            // console.log(`[é¢‘ç‡æé™è®¡ç®—] é«˜é¢‘æé™ç¡®å®šï¼š${highLimit}Hzï¼ˆå‰ä¸€ç‚¹ç‚¹é«˜äºé˜ˆå€¼ï¼‰`);
            break;
        }
    }

    if (!highLimit) {
        const maxFreq = frequencies[frequencies.length - 1];
        highLimit = maxFreq >= 18000 ? 20000 : maxFreq;
        // console.log(`[é¢‘ç‡æé™è®¡ç®—] é«˜é¢‘æé™ç¡®å®šï¼š${highLimit}Hzï¼ˆæ‰€æœ‰ç‚¹å‡é«˜äºé˜ˆå€¼ï¼‰`);
    }

    // æœ€ç»ˆç»“æœ
    // console.log(`[é¢‘ç‡æé™è®¡ç®—] å®Œæˆï¼šä½é¢‘=${lowLimit}Hzï¼Œé«˜é¢‘=${highLimit}Hz`);
    return { low: lowLimit, high: highLimit };
}



/**
 * ç¿»é¡µæ§åˆ¶
 */
function changePage(eqType, direction) {
    const totalPages = eqType === '15' ?
        Math.ceil(15 / eq15PerPage) :
        Math.ceil(31 / eq31PerPage);

    if (eqType === '15') {
        eq15PageIndex = Math.max(0, Math.min(totalPages - 1, eq15PageIndex + direction));
    } else {
        eq31PageIndex = Math.max(0, Math.min(totalPages - 1, eq31PageIndex + direction));
    }

    updateEQDisplays();
}

/**
 * æ›´æ–°åˆ†é¡µä¿¡æ¯
 */
function updatePageInfo() {
    const eq15TotalPages = Math.ceil(15 / eq15PerPage);
    const eq31TotalPages = Math.ceil(31 / eq31PerPage);

    document.getElementById('eq15PageInfo').textContent =
        `ç¬¬${eq15PageIndex + 1}é¡µ/å…±${eq15TotalPages}é¡µ`;
    document.getElementById('eq31PageInfo').textContent =
        `ç¬¬${eq31PageIndex + 1}é¡µ/å…±${eq31TotalPages}é¡µ`;

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.getElementById('eq15PrevBtn').disabled = eq15PageIndex === 0;
    document.getElementById('eq15NextBtn').disabled = eq15PageIndex === eq15TotalPages - 1;
    document.getElementById('eq31PrevBtn').disabled = eq31PageIndex === 0;
    document.getElementById('eq31NextBtn').disabled = eq31PageIndex === eq31TotalPages - 1;
}

/**
 * é‡ç½®EQ
 */
function resetEQ(eqType) {
    if (!analysisResults) return;

    if (eqType === '15') {
        eq15Settings = analysisResults.eq_suggestions.eq_15.map(item =>
            parseFloat(item.adjustment.replace(/[^-\d.]/g, ''))
        );
    } else {
        eq31Settings = analysisResults.eq_suggestions.eq_31.map(item =>
            parseFloat(item.adjustment.replace(/[^-\d.]/g, ''))
        );
    }

    updateEQDisplays();
    updatePredictedCurves();

    // âœ… æ–°å¢ï¼šå¦‚æœå½“å‰æ­£åœ¨ä½¿ç”¨è¿™ä¸ªEQç±»å‹ï¼Œç«‹å³æ›´æ–°éŸ³é¢‘æ•ˆæœ
    if ((eqType === '15' && currentEQType === 'eq15') ||
        (eqType === '31' && currentEQType === 'eq31')) {
        updateAudioEQ();
        showEQUpdateFeedback(currentEQType);
    }
}

/**
 * å½’é›¶EQ
 */
function zeroAllEQ(eqType) {
    if (eqType === '15') {
        eq15Settings.fill(0);
    } else {
        eq31Settings.fill(0);
    }

    updateEQDisplays();
    updatePredictedCurves();

    // âœ… æ–°å¢ï¼šå¦‚æœå½“å‰æ­£åœ¨ä½¿ç”¨è¿™ä¸ªEQç±»å‹ï¼Œç«‹å³æ›´æ–°éŸ³é¢‘æ•ˆæœ
    if ((eqType === '15' && currentEQType === 'eq15') ||
        (eqType === '31' && currentEQType === 'eq31')) {
        updateAudioEQ();
        showEQUpdateFeedback(currentEQType);
    }
}

/**
 * åˆå§‹åŒ–æ›²çº¿æ§åˆ¶
 */
function initializeCurveControls() {
    const controls = document.querySelectorAll('.curve-toggle');
    controls.forEach(control => {
        control.addEventListener('click', function () {
            const curve = this.dataset.curve;
            curveVisibility[curve] = !curveVisibility[curve];
            this.classList.toggle('active', curveVisibility[curve]);

            if (currentChart) {
                drawFrequencyChart(currentChart.chartData);
            }
        });
    });
}

/**
 * é‡æ–°å®ç°EQç±»å‹åˆ‡æ¢
 */
function initializeAudioControls() {
    const testAudioFile = document.getElementById('testAudioFile');
    const audioUploadArea = document.getElementById('audioUploadArea');
    const eqToggleButtons = document.querySelectorAll('.eq-toggle-button');
    const volumeSlider = document.getElementById('volumeSlider');

    // éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ 
    testAudioFile.addEventListener('change', handleAudioFileUpload);
    audioUploadArea.addEventListener('click', () => testAudioFile.click());

    // æ‹–æ‹½ä¸Šä¼ éŸ³é¢‘
    audioUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        audioUploadArea.classList.add('dragover');
    });

    audioUploadArea.addEventListener('dragleave', () => {
        audioUploadArea.classList.remove('dragover');
    });

    audioUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        audioUploadArea.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files);
        const audioFile = files.find(file => file.type.startsWith('audio/'));
        if (audioFile) {
            loadAudioFile(audioFile);
        }
    });

    // EQç±»å‹åˆ‡æ¢ - å¢å¼ºç‰ˆ
    eqToggleButtons.forEach(button => {
        button.addEventListener('click', function () {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            eqToggleButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');

            // è®¾ç½®EQç±»å‹
            const newEQType = this.dataset.eqType;
            console.log(`åˆ‡æ¢EQç±»å‹: ${currentEQType} -> ${newEQType}`);

            currentEQType = newEQType;

            // ç«‹å³åº”ç”¨EQæ›´æ”¹
            updateAudioEQ();

            // æ˜¾ç¤ºåˆ‡æ¢åé¦ˆ
            showEQSwitchFeedback(newEQType);
        });
    });
}

/**
 * æ˜¾ç¤ºEQåˆ‡æ¢åé¦ˆ
 */
function showEQSwitchFeedback(eqType) {
    const messages = {
        'none': 'å·²åˆ‡æ¢åˆ°åŸå§‹éŸ³é¢‘ï¼ˆæ— EQæ•ˆæœï¼‰',
        'eq15': 'å·²åº”ç”¨15æ®µEQæ•ˆæœ',
        'eq31': 'å·²åº”ç”¨31æ®µEQæ•ˆæœ'
    };

    const message = messages[eqType] || 'å·²åˆ‡æ¢EQ';

    // åˆ›å»ºä¸´æ—¶æç¤º
    const feedback = document.createElement('div');
    feedback.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px 25px;
        border-radius: 6px;
        font-weight: 500;
        z-index: 2000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    `;
    feedback.textContent = message;

    document.body.appendChild(feedback);

    // 1.5ç§’åç§»é™¤
    setTimeout(() => {
        if (feedback.parentNode) {
            feedback.parentNode.removeChild(feedback);
        }
    }, 1500);
}

/**
 * å¤„ç†éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ 
 */
function handleAudioFileUpload(event) {
    const file = event.target.files[0];
    if (file) {
        loadAudioFile(file);
    }
}

/**
 * é‡æ–°å®ç°åŠ è½½éŸ³é¢‘æ–‡ä»¶å‡½æ•°ï¼Œæ”¯æŒEQå¤„ç†
 */
function loadAudioFile(file) {
    if (!file.type.startsWith('audio/')) {
        showError('è¯·é€‰æ‹©æœ‰æ•ˆçš„éŸ³é¢‘æ–‡ä»¶');
        return;
    }

    const url = URL.createObjectURL(file);

    // âœ… è®°ä½å½“å‰çš„æ’­æ”¾çŠ¶æ€å’Œæ’­æ”¾ä½ç½®
    const wasPlaying = isPlaying;
    const currentPosition = currentAudio ? currentAudio.currentTime : 0;

    console.log(`åŠ è½½æ–°éŸ³é¢‘æ–‡ä»¶: ${file.name}, ä¹‹å‰çŠ¶æ€: ${wasPlaying ? 'æ’­æ”¾ä¸­' : 'æš‚åœ'}`);

    // æ¸…ç†æ—§çš„éŸ³é¢‘èµ„æº
    if (currentAudio) {
        currentAudio.pause();
        URL.revokeObjectURL(currentAudio.src);
        disconnectAudioProcessing();
    }

    // é‡ç½®æ’­æ”¾çŠ¶æ€
    isPlaying = false;
    currentTime = 0;
    totalDuration = 0;

    // åˆ›å»ºæ–°çš„éŸ³é¢‘å¯¹è±¡
    currentAudio = new Audio(url);
    currentAudio.crossOrigin = 'anonymous';
    currentAudio.volume = document.getElementById('volumeSlider').value / 100;

    currentAudio.addEventListener('loadedmetadata', function () {
        totalDuration = this.duration;
        document.getElementById('totalTime').textContent = formatTime(totalDuration);
        document.getElementById('audioInfo').textContent = file.name;
        document.getElementById('audioControlsPanel').style.display = 'block';

        // åˆå§‹åŒ–éŸ³é¢‘å¤„ç†
        setupAudioProcessing();

        // âœ… å¦‚æœä¹‹å‰æ­£åœ¨æ’­æ”¾ï¼Œè‡ªåŠ¨å¼€å§‹æ’­æ”¾æ–°æ–‡ä»¶
        if (wasPlaying) {
            console.log('è‡ªåŠ¨æ’­æ”¾æ–°æ–‡ä»¶...');
            autoPlayNewFile();
        } else {
            // ç¡®ä¿æŒ‰é’®çŠ¶æ€æ­£ç¡®
            document.getElementById('playPauseBtn').textContent = 'æ’­æ”¾';
        }
    });

    currentAudio.addEventListener('timeupdate', updateProgress);
    currentAudio.addEventListener('ended', function () {
        isPlaying = false;
        document.getElementById('playPauseBtn').textContent = 'æ’­æ”¾';
    });

    currentAudio.addEventListener('error', function () {
        showError('éŸ³é¢‘æ–‡ä»¶åŠ è½½å¤±è´¥');
        isPlaying = false;
        document.getElementById('playPauseBtn').textContent = 'æ’­æ”¾';
    });
}

/**
 * è‡ªåŠ¨æ’­æ”¾æ–°æ–‡ä»¶ - æ–°å¢å‡½æ•°
 */
function autoPlayNewFile() {
    if (!currentAudio) return;

    // ç¡®ä¿AudioContextå¤„äºæ¿€æ´»çŠ¶æ€
    if (audioContext && audioContext.state === 'suspended') {
        audioContext.resume().then(() => {
            performAutoPlay();
        }).catch(error => {
            console.error('æ¢å¤AudioContextå¤±è´¥:', error);
            performAutoPlay(); // ä»ç„¶å°è¯•æ’­æ”¾
        });
    } else {
        performAutoPlay();
    }
}

/**
 * æ‰§è¡Œè‡ªåŠ¨æ’­æ”¾ - æ–°å¢å‡½æ•°
 */
function performAutoPlay() {
    const playPromise = currentAudio.play();

    if (playPromise !== undefined) {
        playPromise.then(() => {
            isPlaying = true;
            document.getElementById('playPauseBtn').textContent = 'æš‚åœ';
            console.log('æ–°æ–‡ä»¶è‡ªåŠ¨æ’­æ”¾æˆåŠŸ');

            // æ˜¾ç¤ºæ–‡ä»¶åˆ‡æ¢æç¤º
            showFileChangeFeedback();
        }).catch(error => {
            console.error('è‡ªåŠ¨æ’­æ”¾å¤±è´¥:', error);
            isPlaying = false;
            document.getElementById('playPauseBtn').textContent = 'æ’­æ”¾';

            // å¦‚æœè‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œæç¤ºç”¨æˆ·æ‰‹åŠ¨æ’­æ”¾
            showError('æ–°æ–‡ä»¶å·²åŠ è½½ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾');
        });
    }
}

/**
 * æ˜¾ç¤ºæ–‡ä»¶åˆ‡æ¢åé¦ˆ - æ–°å¢å‡½æ•°
 */
function showFileChangeFeedback() {
    const feedback = document.createElement('div');
    feedback.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(23, 162, 184, 0.9);
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        font-weight: 500;
        z-index: 2000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        font-size: 14px;
    `;
    feedback.textContent = 'æ–°éŸ³é¢‘æ–‡ä»¶å·²åŠ è½½å¹¶å¼€å§‹æ’­æ”¾';

    document.body.appendChild(feedback);

    // 2ç§’åç§»é™¤
    setTimeout(() => {
        if (feedback.parentNode) {
            feedback.parentNode.removeChild(feedback);
        }
    }, 2000);
}

/**
 * è®¾ç½®éŸ³é¢‘å¤„ç†é“¾
 */
function setupAudioProcessing() {
    try {
        // åˆå§‹åŒ–AudioContext
        initializeAudioContext();

        // æ–­å¼€ä¹‹å‰çš„è¿æ¥
        disconnectAudioProcessing();

        // åˆ›å»ºéŸ³é¢‘æº
        audioSource = audioContext.createMediaElementSource(currentAudio);

        // åˆ›å»ºé¢„è¡°å‡å¢ç›ŠèŠ‚ç‚¹ï¼ˆé˜²å‰Šæ³¢ï¼‰
        preGainNode = audioContext.createGain();
        preGainNode.gain.value = PRE_GAIN_LINEAR; // ç»Ÿä¸€-12dBé¢„è¡°å‡

        // åˆ›å»ºä¸»å¢ç›ŠèŠ‚ç‚¹ï¼ˆç”¨äºéŸ³é‡æ§åˆ¶å’Œå“åº¦è¡¥å¿ï¼‰
        gainNode = audioContext.createGain();

        // åˆ›å»ºåˆ†æå™¨èŠ‚ç‚¹ï¼ˆå¯é€‰ï¼Œç”¨äºå¯è§†åŒ–ï¼‰
        analyzerNode = audioContext.createAnalyser();
        analyzerNode.fftSize = 2048;

        // åˆ›å»ºEQæ»¤æ³¢å™¨é“¾
        createEQFilterChains();

        // è¿æ¥éŸ³é¢‘å¤„ç†é“¾
        connectAudioNodes();

        console.log('éŸ³é¢‘å¤„ç†é“¾è®¾ç½®å®Œæˆï¼Œé¢„è¡°å‡:', PRE_GAIN_DB, 'dB');

        // åº”ç”¨å½“å‰EQè®¾ç½®
        updateAudioEQ();

    } catch (error) {
        console.error('éŸ³é¢‘å¤„ç†è®¾ç½®å¤±è´¥:', error);
        showError('éŸ³é¢‘å¤„ç†åˆå§‹åŒ–å¤±è´¥: ' + error.message);
    }
}

/**
 * åˆ›å»ºEQæ»¤æ³¢å™¨é“¾
 */
function createEQFilterChains() {
    // 15æ®µEQé¢‘ç‡å’ŒQå€¼
    const eq15Frequencies = [25, 40, 63, 100, 160, 250, 400, 630, 1000, 1600, 2500, 4000, 6300, 10000, 16000];
    const eq15Q = 2.15;

    // 31æ®µEQé¢‘ç‡å’ŒQå€¼
    const eq31Frequencies = [20, 25, 31.5, 40, 50, 63, 80, 100, 125, 160, 200, 250, 315, 400, 500,
        630, 800, 1000, 1250, 1600, 2000, 2500, 3150, 4000, 5000, 6300,
        8000, 10000, 12500, 16000, 20000];
    const eq31Q = 4.31;

    // æ¸…ç©ºç°æœ‰æ»¤æ³¢å™¨
    eq15FilterNodes = [];
    eq31FilterNodes = [];

    // åˆ›å»º15æ®µEQæ»¤æ³¢å™¨
    eq15Frequencies.forEach((frequency, index) => {
        const filter = audioContext.createBiquadFilter();
        filter.type = 'peaking';
        filter.frequency.value = frequency;
        filter.Q.value = eq15Q;
        filter.gain.value = 0; // åˆå§‹å¢ç›Šä¸º0dB
        eq15FilterNodes.push(filter);
    });

    // åˆ›å»º31æ®µEQæ»¤æ³¢å™¨
    eq31Frequencies.forEach((frequency, index) => {
        const filter = audioContext.createBiquadFilter();
        filter.type = 'peaking';
        filter.frequency.value = frequency;
        filter.Q.value = eq31Q;
        filter.gain.value = 0; // åˆå§‹å¢ç›Šä¸º0dB
        eq31FilterNodes.push(filter);
    });

    console.log(`åˆ›å»ºäº†${eq15FilterNodes.length}ä¸ª15æ®µEQæ»¤æ³¢å™¨å’Œ${eq31FilterNodes.length}ä¸ª31æ®µEQæ»¤æ³¢å™¨`);
}

/**
 * è¿æ¥éŸ³é¢‘èŠ‚ç‚¹ - åŒ…å«é¢„è¡°å‡
 */
function connectAudioNodes() {
    if (!audioSource || !preGainNode || !gainNode || !analyzerNode) {
        throw new Error('éŸ³é¢‘èŠ‚ç‚¹æœªæ­£ç¡®åˆ›å»º');
    }

    // åŸºç¡€è¿æ¥ï¼šéŸ³é¢‘æº -> é¢„è¡°å‡ -> ä¸»å¢ç›Š -> åˆ†æå™¨ -> è¾“å‡º
    audioSource.connect(preGainNode);
    preGainNode.connect(gainNode);
    gainNode.connect(analyzerNode);
    analyzerNode.connect(audioContext.destination);

    console.log('éŸ³é¢‘èŠ‚ç‚¹è¿æ¥å®Œæˆï¼ŒåŒ…å«é¢„è¡°å‡');
}

/**
 * æ–­å¼€éŸ³é¢‘å¤„ç†è¿æ¥ - åŒ…å«é¢„è¡°å‡èŠ‚ç‚¹
 */
function disconnectAudioProcessing() {
    try {
        // æ–­å¼€æ‰€æœ‰è¿æ¥
        if (audioSource) {
            audioSource.disconnect();
            audioSource = null;
        }

        if (preGainNode) {
            preGainNode.disconnect();
            preGainNode = null;
        }

        if (gainNode) {
            gainNode.disconnect();
            gainNode = null;
        }

        if (analyzerNode) {
            analyzerNode.disconnect();
            analyzerNode = null;
        }

        // æ–­å¼€EQæ»¤æ³¢å™¨
        eq15FilterNodes.forEach(filter => {
            try {
                filter.disconnect();
            } catch (e) {
                // å¿½ç•¥å·²æ–­å¼€çš„èŠ‚ç‚¹
            }
        });

        eq31FilterNodes.forEach(filter => {
            try {
                filter.disconnect();
            } catch (e) {
                // å¿½ç•¥å·²æ–­å¼€çš„èŠ‚ç‚¹
            }
        });

        eq15FilterNodes = [];
        eq31FilterNodes = [];

    } catch (error) {
        console.error('æ–­å¼€éŸ³é¢‘è¿æ¥æ—¶å‡ºé”™:', error);
    }
}

/**
 * æ”¹è¿›çš„éŸ³é‡æ§åˆ¶ - è€ƒè™‘å“åº¦è¡¥å¿
 */
function updateVolumeControl() {
    const volumeSlider = document.getElementById('volumeSlider');

    volumeSlider.addEventListener('input', function () {
        const volume = this.value / 100;

        // æ›´æ–°HTML5 Audioå…ƒç´ éŸ³é‡ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
        if (currentAudio) {
            currentAudio.volume = 1.0; // ä¿æŒæœ€å¤§ï¼Œè®©Web Audio APIæ§åˆ¶éŸ³é‡
        }

        // é‡æ–°åº”ç”¨å“åº¦è¡¥å¿ï¼ˆåŒ…å«æ–°çš„ç”¨æˆ·éŸ³é‡ï¼‰
        updateAudioEQ();

        document.getElementById('volumeValue').textContent = this.value + '%';
    });
}

/**
 * åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡å’ŒEQå¤„ç†é“¾
 */
function initializeAudioContext() {
    if (!audioContext) {
        // åˆ›å»ºAudioContext
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }

    // ç¡®ä¿AudioContextå¤„äºè¿è¡ŒçŠ¶æ€
    if (audioContext.state === 'suspended') {
        audioContext.resume();
    }
}

/**
 * æ›´æ–°éŸ³é¢‘EQ - ç»Ÿä¸€å“åº¦åŒ¹é…ç‰ˆæœ¬
 */
function updateAudioEQ() {
    if (!audioContext || !audioSource || !preGainNode || !gainNode || !analyzerNode) {
        console.log('éŸ³é¢‘å¤„ç†é“¾æœªåˆå§‹åŒ–ï¼Œè·³è¿‡EQæ›´æ–°');
        return;
    }

    try {
        // æ–­å¼€å½“å‰çš„EQè¿æ¥ï¼Œé‡æ–°è¿æ¥
        disconnectEQChain();

        // è®¡ç®—ç»Ÿä¸€å“åº¦åŸºå‡†
        const loudnessBasis = calculateUnifiedLoudnessBasis();
        let finalCompensation;

        if (currentEQType === 'none') {
            // æ— EQï¼šä½¿ç”¨åŸºå‡†è¡¥å¿
            preGainNode.connect(gainNode);
            finalCompensation = loudnessBasis.baseline;

        } else if (currentEQType === 'eq15') {
            // åº”ç”¨15æ®µEQ
            applyEQChain(eq15FilterNodes, eq15Settings);
            finalCompensation = loudnessBasis.eq15Compensation;

        } else if (currentEQType === 'eq31') {
            // åº”ç”¨31æ®µEQ
            applyEQChain(eq31FilterNodes, eq31Settings);
            finalCompensation = loudnessBasis.eq31Compensation;
        }

        // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿æœ€ç»ˆå¢ç›Šä¸ä¼šå¯¼è‡´å‰Šæ³¢
        const currentEQSettings = currentEQType === 'eq15' ? eq15Settings :
            currentEQType === 'eq31' ? eq31Settings :
                new Array(15).fill(0);

        const safeLimit = calculateSafeGainLimit(currentEQSettings);
        finalCompensation = Math.min(finalCompensation, safeLimit);

        // åº”ç”¨æœ€ç»ˆå“åº¦è¡¥å¿
        applyUnifiedLoudnessCompensation(finalCompensation);

        // è¿æ¥åˆ°è¾“å‡º
        gainNode.connect(analyzerNode);
        analyzerNode.connect(audioContext.destination);

        console.log(`EQæ›´æ–°å®Œæˆï¼Œç±»å‹: ${currentEQType}, ç»Ÿä¸€å“åº¦è¡¥å¿: ${finalCompensation.toFixed(1)}dB`);

        // æ›´æ–°æ˜¾ç¤º
        updateUnifiedLoudnessIndicator(finalCompensation, loudnessBasis);

    } catch (error) {
        console.error('æ›´æ–°EQå¤±è´¥:', error);
        showError('EQæ›´æ–°å¤±è´¥: ' + error.message);
    }
}

/**
 * åº”ç”¨ç»Ÿä¸€å“åº¦è¡¥å¿ - æ–°å¢å‡½æ•°
 */
function applyUnifiedLoudnessCompensation(compensationDb) {
    if (!gainNode) return;

    // è½¬æ¢ä¸ºçº¿æ€§å¢ç›Š
    const compensationLinear = Math.pow(10, compensationDb / 20);

    // åº”ç”¨ç”¨æˆ·éŸ³é‡è®¾ç½®
    const userVolume = document.getElementById('volumeSlider').value / 100;
    const finalGain = compensationLinear * userVolume;

    // å¹³æ»‘è¿‡æ¸¡åˆ°æ–°å¢ç›Š
    gainNode.gain.setTargetAtTime(finalGain, audioContext.currentTime, 0.05);

    console.log(`ç»Ÿä¸€å“åº¦è¡¥å¿: ${compensationDb.toFixed(1)}dB, ç”¨æˆ·éŸ³é‡: ${(userVolume * 100).toFixed(0)}%, æœ€ç»ˆå¢ç›Š: ${(20 * Math.log10(finalGain)).toFixed(1)}dB`);
}

/**
 * æ›´æ–°ç»Ÿä¸€å“åº¦æŒ‡ç¤ºå™¨ - æ–°å¢å‡½æ•°
 */
function updateUnifiedLoudnessIndicator(finalCompensation, loudnessBasis) {
    const indicator = document.getElementById('loudnessIndicator');
    const preGainText = `é¢„è¡°å‡: ${PRE_GAIN_DB}dB`;
    const baselineText = `ç»Ÿä¸€åŸºçº¿: ${loudnessBasis.baseline.toFixed(1)}dB`;
    const finalText = `æœ€ç»ˆè¡¥å¿: ${finalCompensation.toFixed(1)}dB`;
    const totalText = `å‡€è°ƒæ•´: ${(PRE_GAIN_DB + finalCompensation).toFixed(1)}dB`;

    // å®‰å…¨çŠ¶æ€æŒ‡ç¤º
    const currentEQSettings = currentEQType === 'eq15' ? eq15Settings :
        currentEQType === 'eq31' ? eq31Settings :
            new Array(15).fill(0);
    const maxEQGain = Math.max(0, ...currentEQSettings);
    const theoreticalMax = PRE_GAIN_DB + finalCompensation + maxEQGain;
    const safetyStatus = theoreticalMax <= -1 ? 'âœ“ å®‰å…¨' : 'âš  æ³¨æ„';
    const safetyColor = theoreticalMax <= -1 ? '#28a745' : '#ffc107';

    indicator.innerHTML = `
        <div style="font-size: 12px; line-height: 1.4;">
            <div>${preGainText} (é˜²å‰Šæ³¢)</div>
            <div>${baselineText} (ç»Ÿä¸€åŸºå‡†)</div>
            <div>${finalText} (å½“å‰æ¨¡å¼)</div>
            <div style="font-weight: bold; color: #2c5aa0;">${totalText}</div>
            <div style="font-weight: bold; color: ${safetyColor}; margin-top: 2px;">${safetyStatus}</div>
        </div>
    `;
}

/**
 * æ–­å¼€EQé“¾è¿æ¥ - æ”¹è¿›ç‰ˆ
 */
function disconnectEQChain() {
    try {
        // æ–­å¼€é¢„è¡°å‡èŠ‚ç‚¹
        if (preGainNode) {
            preGainNode.disconnect();
        }

        // æ–­å¼€ä¸»å¢ç›ŠèŠ‚ç‚¹
        if (gainNode) {
            gainNode.disconnect();
        }

        // æ–­å¼€åˆ†æå™¨
        if (analyzerNode) {
            analyzerNode.disconnect();
        }

        // æ–­å¼€æ‰€æœ‰EQæ»¤æ³¢å™¨
        [...eq15FilterNodes, ...eq31FilterNodes].forEach(filter => {
            try {
                filter.disconnect();
            } catch (e) {
                // èŠ‚ç‚¹å¯èƒ½å·²æ–­å¼€
            }
        });

    } catch (error) {
        console.error('æ–­å¼€EQé“¾æ—¶å‡ºé”™:', error);
    }
}

/**
 * åº”ç”¨EQæ»¤æ³¢å™¨é“¾ - æ”¹è¿›ç‰ˆ
 */
function applyEQChain(filterNodes, eqSettings) {
    if (!filterNodes || filterNodes.length === 0) {
        console.warn('EQæ»¤æ³¢å™¨èŠ‚ç‚¹ä¸ºç©º');
        return;
    }

    // æ›´æ–°æ»¤æ³¢å™¨å¢ç›Šå€¼
    filterNodes.forEach((filter, index) => {
        if (index < eqSettings.length) {
            const targetGain = eqSettings[index];
            filter.gain.setTargetAtTime(targetGain, audioContext.currentTime, 0.1);
        }
    });

    // ä¸²è”è¿æ¥æ»¤æ³¢å™¨ï¼šé¢„è¡°å‡ -> EQé“¾ -> ä¸»å¢ç›Š
    let currentNode = preGainNode;

    filterNodes.forEach((filter) => {
        currentNode.connect(filter);
        currentNode = filter;
    });

    // æœ€åä¸€ä¸ªæ»¤æ³¢å™¨è¿æ¥åˆ°ä¸»å¢ç›ŠèŠ‚ç‚¹
    currentNode.connect(gainNode);

    console.log(`åº”ç”¨äº†${filterNodes.length}ä¸ªEQæ»¤æ³¢å™¨`);
}

/**
 * æ”¹è¿›çš„å“åº¦è¡¥å¿è®¡ç®— - åŸºäºISO 226ç­‰å“åº¦æ›²çº¿
 */
function calculateImprovedLoudnessCompensation(eqSettings, eqType) {
    // åŸºäºISO 226ç­‰å“åº¦æ›²çº¿çš„æƒé‡ç³»æ•°ï¼ˆ40 phonç­‰å“åº¦æ›²çº¿ï¼‰
    const loudnessWeights = eqType === 'eq15' ?
        // 15æ®µEQæƒé‡ï¼šåŸºäº40phonç­‰å“åº¦æ›²çº¿ï¼Œ1kHz = 1.0
        [0.15, 0.25, 0.35, 0.50, 0.65, 0.80, 0.90, 0.95, 1.00, 0.95, 0.85, 0.75, 0.60, 0.45, 0.30] :
        // 31æ®µEQæƒé‡ï¼šæ›´ç²¾ç»†çš„ç­‰å“åº¦æ›²çº¿
        [0.10, 0.15, 0.20, 0.25, 0.30, 0.35, 0.45, 0.55, 0.65, 0.75, 0.85, 0.90, 0.95, 0.98, 1.00,
            0.98, 0.95, 1.00, 0.98, 0.95, 0.90, 0.85, 0.75, 0.65, 0.55, 0.45, 0.35, 0.25, 0.20, 0.15, 0.10];

    // è®¡ç®—æ„ŸçŸ¥å“åº¦å˜åŒ–ï¼ˆStevenså¹‚å¾‹ä¿®æ­£ï¼‰
    let totalLoudnessChange = 0;
    let totalWeight = 0;

    eqSettings.forEach((gainDb, index) => {
        if (index < loudnessWeights.length && Math.abs(gainDb) > 0.1) {
            const weight = loudnessWeights[index];

            // Stevenså¹‚å¾‹ï¼šå“åº¦æ„ŸçŸ¥ âˆ å£°å‹^0.3
            const powerRatio = Math.pow(10, gainDb / 10);
            const loudnessRatio = Math.pow(powerRatio, 0.3);
            const loudnessChangeDb = 10 * Math.log10(loudnessRatio);

            totalLoudnessChange += loudnessChangeDb * weight;
            totalWeight += weight;
        }
    });

    const avgLoudnessChange = totalWeight > 0 ? totalLoudnessChange / totalWeight : 0;

    // é™åˆ¶å•ç‹¬è¡¥å¿èŒƒå›´
    return Math.max(-8, Math.min(8, avgLoudnessChange));
}

/**
 * è®¡ç®—ç»Ÿä¸€å“åº¦åŸºå‡† - æ­£ç¡®ç‰ˆï¼šè®©æ‰€æœ‰æ¨¡å¼å“åº¦ç›¸ç­‰
 */
function calculateUnifiedLoudnessBasis() {
    if (!analysisResults) {
        return { baseline: -4, eq15Compensation: -4, eq31Compensation: -4 };
    }

    // è®¡ç®—å„æ¨¡å¼çš„å®é™…æ„ŸçŸ¥å“åº¦å˜åŒ–
    const eq15LoudnessChange = calculateActualLoudnessChange(eq15Settings, 'eq15');
    const eq31LoudnessChange = calculateActualLoudnessChange(eq31Settings, 'eq31');
    const noneModeLoudness = 0; // æ— EQæ¨¡å¼ä½œä¸ºåŸºå‡†

    console.log(`å„æ¨¡å¼æ„ŸçŸ¥å“åº¦å˜åŒ–:`);
    console.log(`  æ— EQæ¨¡å¼: ${noneModeLoudness.toFixed(1)}dB`);
    console.log(`  15æ®µEQæ¨¡å¼: ${eq15LoudnessChange.toFixed(1)}dB`);
    console.log(`  31æ®µEQæ¨¡å¼: ${eq31LoudnessChange.toFixed(1)}dB`);

    // æ‰¾åˆ°æœ€å®‰é™çš„æ¨¡å¼ï¼ˆæœ€å°å€¼ï¼‰
    const minLoudness = Math.min(noneModeLoudness, eq15LoudnessChange, eq31LoudnessChange);

    // ç»Ÿä¸€åŸºå‡†ï¼šæ‰€æœ‰æ¨¡å¼éƒ½è°ƒæ•´åˆ°æœ€å®‰é™æ¨¡å¼çš„æ°´å¹³ï¼Œå†å‡å»å®‰å…¨ä½™é‡
    const safetyMargin = 2; // 2dBå®‰å…¨ä½™é‡
    const unifiedBaseline = minLoudness - safetyMargin;

    // è®¡ç®—å„æ¨¡å¼éœ€è¦çš„è¡¥å¿ï¼šè®©æ‰€æœ‰æ¨¡å¼éƒ½è¾¾åˆ°ç»Ÿä¸€åŸºå‡†
    const noneCompensation = unifiedBaseline - noneModeLoudness;
    const eq15Compensation = unifiedBaseline - eq15LoudnessChange;
    const eq31Compensation = unifiedBaseline - eq31LoudnessChange;

    console.log(`ç»Ÿä¸€å“åº¦åŸºå‡†è®¡ç®—:`);
    console.log(`  æœ€å®‰é™æ¨¡å¼å“åº¦: ${minLoudness.toFixed(1)}dB`);
    console.log(`  ç»Ÿä¸€åŸºå‡†: ${unifiedBaseline.toFixed(1)}dB`);
    console.log(`  æ— EQè¡¥å¿: ${noneCompensation.toFixed(1)}dB`);
    console.log(`  15æ®µEQè¡¥å¿: ${eq15Compensation.toFixed(1)}dB`);
    console.log(`  31æ®µEQè¡¥å¿: ${eq31Compensation.toFixed(1)}dB`);

    return {
        baseline: noneCompensation,
        eq15Compensation: eq15Compensation,
        eq31Compensation: eq31Compensation
    };
}

/**
 * è®¡ç®—å®é™…æ„ŸçŸ¥å“åº¦å˜åŒ– - ä¸¥æ ¼åŸºäºISO 226ç­‰å“åº¦æ›²çº¿
 */
function calculateActualLoudnessChange(eqSettings, eqType) {
    // åŸºäºISO 226æ ‡å‡†40 phonç­‰å“åº¦æ›²çº¿çš„ç²¾ç¡®æƒé‡
    const iso226Weights = eqType === 'eq15' ?
        // 15æ®µEQé¢‘ç‡å¯¹åº”çš„ISO 226æƒé‡
        [0.0079, 0.0141, 0.0316, 0.0794, 0.1995, 0.3981, 0.6310, 0.8913, 1.0000, 0.9441, 0.7943, 0.6310, 0.4467, 0.2818, 0.0794] :
        // 31æ®µEQé¢‘ç‡å¯¹åº”çš„ISO 226æƒé‡  
        [0.0063, 0.0079, 0.0100, 0.0141, 0.0200, 0.0316, 0.0501, 0.0794, 0.1259, 0.1995, 0.3162, 0.3981, 0.5012, 0.6310, 0.7943,
            0.8913, 0.9441, 1.0000, 1.0000, 0.9441, 0.8913, 0.7943, 0.7079, 0.6310, 0.5623, 0.4467, 0.3548, 0.2818, 0.1995, 0.0794, 0.0200];

    let weightedSum = 0;
    let totalWeight = 0;

    eqSettings.forEach((gainDb, index) => {
        if (index < iso226Weights.length && Math.abs(gainDb) > 0.1) {
            const weight = iso226Weights[index];

            // ä½¿ç”¨åŠŸç‡åŸŸè®¡ç®—ï¼ˆ10^(dB/10)ï¼‰ç„¶åè½¬å›dBåŸŸ
            const powerRatio = Math.pow(10, gainDb / 10);
            const weightedPowerContribution = (powerRatio - 1) * weight;

            weightedSum += weightedPowerContribution;
            totalWeight += weight;
        }
    });

    // è®¡ç®—æ€»çš„åŠ æƒåŠŸç‡å˜åŒ–
    const totalWeightedPowerChange = weightedSum;

    // è½¬æ¢ä¸ºæ„ŸçŸ¥å“åº¦å˜åŒ–ï¼ˆdBï¼‰
    const loudnessChangeDb = totalWeightedPowerChange > 0 ?
        10 * Math.log10(1 + totalWeightedPowerChange) :
        -10 * Math.log10(1 - totalWeightedPowerChange);

    return loudnessChangeDb;
}

/**
 * è®¡ç®—å®‰å…¨å¢ç›Šé™åˆ¶ - æ–°å¢å‡½æ•°
 */
function calculateSafeGainLimit(eqSettings) {
    // è®¡ç®—EQçš„æœ€å¤§å¯èƒ½å¢ç›Š
    const maxEQGain = Math.max(0, ...eqSettings);

    // å®‰å…¨è¾¹ç•Œï¼šé¢„è¡°å‡(-12dB) + EQå¢ç›Š + å®‰å…¨ä½™é‡(-3dB) â‰¤ -1dB
    const safeLimit = -1 - PRE_GAIN_DB - maxEQGain - 3;

    return Math.min(safeLimit, 0); // ç¡®ä¿ä¸è¶…è¿‡0dB
}


/**
 * åº”ç”¨å“åº¦è¡¥å¿
 */
function applyLoudnessCompensation(compensationDb) {
    if (!gainNode) return;

    // è½¬æ¢ä¸ºçº¿æ€§å¢ç›Š
    const compensationLinear = Math.pow(10, compensationDb / 20);

    // åº”ç”¨ç”¨æˆ·éŸ³é‡è®¾ç½®
    const userVolume = document.getElementById('volumeSlider').value / 100;
    const finalGain = compensationLinear * userVolume;

    // å¹³æ»‘è¿‡æ¸¡åˆ°æ–°å¢ç›Š
    gainNode.gain.setTargetAtTime(finalGain, audioContext.currentTime, 0.1);

    console.log(`å“åº¦è¡¥å¿: ${compensationDb.toFixed(1)}dB, ç”¨æˆ·éŸ³é‡: ${(userVolume * 100).toFixed(0)}%, æœ€ç»ˆå¢ç›Š: ${(20 * Math.log10(finalGain)).toFixed(1)}dB`);
}


/**
 * è·å–æœ€åè¿æ¥çš„èŠ‚ç‚¹
 */
function getLastConnectedNode() {
    if (currentEQType === 'eq15' && eq15FilterNodes.length > 0) {
        return eq15FilterNodes[eq15FilterNodes.length - 1];
    } else if (currentEQType === 'eq31' && eq31FilterNodes.length > 0) {
        return eq31FilterNodes[eq31FilterNodes.length - 1];
    } else {
        return audioSource;
    }
}

/**
 * æ›´æ–°å“åº¦æŒ‡ç¤ºå™¨ - æ”¹è¿›ç‰ˆæ˜¾ç¤º
 */
function updateLoudnessIndicator(compensation) {
    const indicator = document.getElementById('loudnessIndicator');
    const preGainText = `é¢„è¡°å‡: ${PRE_GAIN_DB}dB`;
    const compensationText = `å“åº¦è¡¥å¿: ${compensation.toFixed(1)}dB`;
    const totalText = `æ€»è°ƒæ•´: ${(PRE_GAIN_DB + compensation).toFixed(1)}dB`;

    indicator.innerHTML = `
        <div style="font-size: 12px; line-height: 1.4;">
            <div>${preGainText} (é˜²å‰Šæ³¢)</div>
            <div>${compensationText} (æ™ºèƒ½åŒ¹é…)</div>
            <div style="font-weight: bold; color: #2c5aa0;">${totalText}</div>
        </div>
    `;
}

/**
 * åˆå§‹åŒ–æ”¹è¿›çš„éŸ³é¢‘æ§åˆ¶
 */
function initializeImprovedAudioControls() {
    const testAudioFile = document.getElementById('testAudioFile');
    const audioUploadArea = document.getElementById('audioUploadArea');
    const eqToggleButtons = document.querySelectorAll('.eq-toggle-button');

    // éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ 
    testAudioFile.addEventListener('change', handleAudioFileUpload);
    audioUploadArea.addEventListener('click', () => testAudioFile.click());

    // æ‹–æ‹½ä¸Šä¼ éŸ³é¢‘
    audioUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        audioUploadArea.classList.add('dragover');
    });

    audioUploadArea.addEventListener('dragleave', () => {
        audioUploadArea.classList.remove('dragover');
    });

    audioUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        audioUploadArea.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files);
        const audioFile = files.find(file => file.type.startsWith('audio/'));
        if (audioFile) {
            loadAudioFile(audioFile);
        }
    });

    // EQç±»å‹åˆ‡æ¢
    eqToggleButtons.forEach(button => {
        button.addEventListener('click', function () {
            eqToggleButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');

            const newEQType = this.dataset.eqType;
            console.log(`åˆ‡æ¢EQç±»å‹: ${currentEQType} -> ${newEQType}`);

            currentEQType = newEQType;
            updateAudioEQ();
            showEQSwitchFeedback(newEQType);
        });
    });

    // æ”¹è¿›çš„éŸ³é‡æ§åˆ¶
    updateVolumeControl();

    // è®¾ç½®åˆå§‹éŸ³é‡
    const volumeSlider = document.getElementById('volumeSlider');
    if (volumeSlider) {
        volumeSlider.value = 50; // æé«˜é»˜è®¤éŸ³é‡åˆ°50%
        document.getElementById('volumeValue').textContent = '50%';
    }

    console.log('æ”¹è¿›çš„éŸ³é¢‘æ§åˆ¶åˆå§‹åŒ–å®Œæˆ');
}

// æµ‹è¯•å“åº¦åŒ¹é…çš„è¾…åŠ©å‡½æ•°
function testLoudnessMatching() {
    console.log('=== å“åº¦åŒ¹é…æµ‹è¯• ===');
    console.log('é¢„è¡°å‡:', PRE_GAIN_DB, 'dB');

    // æµ‹è¯•ä¸åŒEQè®¾ç½®çš„å“åº¦è¡¥å¿
    const testEQ15 = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]; // å…¨é›¶
    const testEQ15Boost = [3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3]; // å…¨+3dB
    const testEQ15Cut = [-3, -3, -3, -3, -3, -3, -3, -3, -3, -3, -3, -3, -3, -3, -3]; // å…¨-3dB

    console.log('å…¨é›¶EQè¡¥å¿:', calculateImprovedLoudnessCompensation(testEQ15, 'eq15').toFixed(1), 'dB');
    console.log('å…¨+3dB EQè¡¥å¿:', calculateImprovedLoudnessCompensation(testEQ15Boost, 'eq15').toFixed(1), 'dB');
    console.log('å…¨-3dB EQè¡¥å¿:', calculateImprovedLoudnessCompensation(testEQ15Cut, 'eq15').toFixed(1), 'dB');
}

/**
 * æ”¹è¿›çš„æ’­æ”¾/æš‚åœæ§åˆ¶
 */
function togglePlayPause() {
    if (!currentAudio) return;

    // ç¡®ä¿AudioContextå¤„äºæ¿€æ´»çŠ¶æ€
    if (audioContext && audioContext.state === 'suspended') {
        audioContext.resume().then(() => {
            performPlayPause();
        }).catch(error => {
            console.error('æ¢å¤AudioContextå¤±è´¥:', error);
            performPlayPause(); // ä»ç„¶å°è¯•æ’­æ”¾
        });
    } else {
        performPlayPause();
    }
}

function performPlayPause() {
    if (isPlaying) {
        currentAudio.pause();
        isPlaying = false;
        document.getElementById('playPauseBtn').textContent = 'æ’­æ”¾';
    } else {
        const playPromise = currentAudio.play();

        if (playPromise !== undefined) {
            playPromise.then(() => {
                isPlaying = true;
                document.getElementById('playPauseBtn').textContent = 'æš‚åœ';
            }).catch(error => {
                console.error('æ’­æ”¾å¤±è´¥:', error);
                showError('éŸ³é¢‘æ’­æ”¾å¤±è´¥: ' + error.message);
            });
        }
    }
}

/**
 * åœæ­¢æ’­æ”¾
 */
function stopAudio() {
    if (!currentAudio) return;

    currentAudio.pause();
    currentAudio.currentTime = 0;
    isPlaying = false;
    document.getElementById('playPauseBtn').textContent = 'æ’­æ”¾';
}

/**
 * é‡ç½®æ’­æ”¾ä½ç½®
 */
function rewindAudio() {
    if (!currentAudio) return;

    currentAudio.currentTime = 0;
}

/**
 * è·³è½¬æ’­æ”¾ä½ç½®
 */
function seekAudio(event) {
    if (!currentAudio) return;

    const progressContainer = event.currentTarget;
    const rect = progressContainer.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const percentage = clickX / rect.width;
    const newTime = percentage * totalDuration;

    currentAudio.currentTime = newTime;
}

/**
 * æ›´æ–°æ’­æ”¾è¿›åº¦
 */
function updateProgress() {
    if (!currentAudio) return;

    currentTime = currentAudio.currentTime;
    const percentage = (currentTime / totalDuration) * 100;

    document.getElementById('progressBar').style.width = percentage + '%';
    document.getElementById('currentTime').textContent = formatTime(currentTime);
}

/**
 * æ ¼å¼åŒ–æ—¶é—´
 */
function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
}

/**
 * åˆå§‹åŒ–é¢‘ç‡æ§åˆ¶
 */
function initializeFrequencyControls() {
    document.getElementById('targetLowFreq').addEventListener('change', updateFrequencyRange);
    document.getElementById('targetHighFreq').addEventListener('change', updateFrequencyRange);
}

/**
 * æ›´æ–°é¢‘ç‡èŒƒå›´
 */
function updateFrequencyRange() {
    targetLowFreq = parseInt(document.getElementById('targetLowFreq').value);
    targetHighFreq = parseInt(document.getElementById('targetHighFreq').value);

    // éªŒè¯èŒƒå›´
    if (targetLowFreq >= targetHighFreq) {
        showError('ä½é¢‘æé™å¿…é¡»å°äºé«˜é¢‘æé™');
        return;
    }

    console.log(`ç›®æ ‡é¢‘ç‡èŒƒå›´æ›´æ–°: ${targetLowFreq}Hz - ${targetHighFreq}Hz`);
}

/**
 * é‡æ–°ä¼˜åŒ–EQ - ä½¿ç”¨åç«¯å®Œæ•´ç®—æ³•
 */
async function reoptimizeEQ() {
    if (!analysisResults) {
        showError('è¯·å…ˆå®ŒæˆéŸ³é¢‘åˆ†æ');
        return;
    }

    console.log(`é‡æ–°ä¼˜åŒ–EQï¼Œç›®æ ‡èŒƒå›´: ${targetLowFreq}Hz - ${targetHighFreq}Hzï¼ˆä½¿ç”¨åç«¯ç®—æ³•ï¼‰`);

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    // showLoading();

    try {
        // è®°å½•å½“å‰EQç±»å‹ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦å®æ—¶æ›´æ–°éŸ³é¢‘
        const wasUsingEQ15 = (currentEQType === 'eq15');
        const wasUsingEQ31 = (currentEQType === 'eq31');

        // å‡†å¤‡å‘é€ç»™åç«¯çš„æ•°æ®
        const requestData = {
            frequencies: analysisResults.chart_data.frequencies,
            measured_spectrum_diff: analysisResults.chart_data.measured_spectrum_diff,
            target_low_freq: targetLowFreq,
            target_high_freq: targetHighFreq
        };

        console.log('å‘åç«¯å‘é€é‡æ–°ä¼˜åŒ–è¯·æ±‚...');

        // è°ƒç”¨åç«¯API
        const response = await fetch('/api/reoptimize', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        const result = await response.json();

        if (result.success) {
            console.log('åç«¯é‡æ–°ä¼˜åŒ–æˆåŠŸ');

            // æ›´æ–°EQè®¾ç½®
            eq15Settings = result.eq_15_settings;
            eq31Settings = result.eq_31_settings;

            // æ›´æ–°å›¾è¡¨æ•°æ®
            const updatedChartData = {
                ...analysisResults.chart_data,
                eq_15_applied_diff: result.eq_15_applied_diff,
                eq_31_applied_diff: result.eq_31_applied_diff
            };

            // é‡æ–°ç»˜åˆ¶å›¾è¡¨
            drawFrequencyChart(updatedChartData);

            // æ›´æ–°æ˜¾ç¤º
            updateEQDisplays();

            // æ›´æ–°é¢‘ç‡æé™
            updateFrequencyLimits(result.frequency_limits);

            // å¦‚æœå½“å‰æ­£åœ¨ä½¿ç”¨EQè¿›è¡ŒéŸ³é¢‘è¯•å¬ï¼Œç«‹å³æ›´æ–°éŸ³é¢‘æ•ˆæœ
            if (wasUsingEQ15 || wasUsingEQ31) {
                console.log(`æ£€æµ‹åˆ°å½“å‰æ­£åœ¨ä½¿ç”¨${currentEQType}ï¼Œç«‹å³æ›´æ–°éŸ³é¢‘EQæ•ˆæœ`);
                updateAudioEQ();
                showEQUpdateFeedback(currentEQType);
            }

            console.log('EQé‡æ–°ä¼˜åŒ–å®Œæˆï¼ˆåç«¯ç®—æ³•ï¼‰');

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            const successMsg = `EQå·²ä½¿ç”¨åç«¯å®Œæ•´ç®—æ³•é‡æ–°ä¼˜åŒ– | ç›®æ ‡é¢‘ç‡èŒƒå›´: ${targetLowFreq}Hz - ${targetHighFreq}Hz`;
            showSuccessMessage(successMsg);

        } else {
            throw new Error(result.error || 'åç«¯é‡æ–°ä¼˜åŒ–å¤±è´¥');
        }

    } catch (error) {
        console.error('é‡æ–°ä¼˜åŒ–EQå¤±è´¥:', error);
        showError('é‡æ–°ä¼˜åŒ–å¤±è´¥: ' + error.message);
    } finally {
        // hideLoading();
    }
}

/**
 * æ˜¾ç¤ºEQæ›´æ–°åé¦ˆ - æ–°å¢å‡½æ•°
 */
function showEQUpdateFeedback(eqType) {
    const messages = {
        'eq15': '15æ®µEQéŸ³é¢‘æ•ˆæœå·²å®æ—¶æ›´æ–°',
        'eq31': '31æ®µEQéŸ³é¢‘æ•ˆæœå·²å®æ—¶æ›´æ–°'
    };

    const message = messages[eqType];
    if (!message) return;

    // åˆ›å»ºä¸´æ—¶æç¤º
    const feedback = document.createElement('div');
    feedback.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(40, 167, 69, 0.9);
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        font-weight: 500;
        z-index: 2000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        font-size: 14px;
    `;
    feedback.textContent = message;

    document.body.appendChild(feedback);

    // 1ç§’åç§»é™¤ï¼ˆæ¯”åˆ‡æ¢æç¤ºçŸ­ä¸€äº›ï¼‰
    setTimeout(() => {
        if (feedback.parentNode) {
            feedback.parentNode.removeChild(feedback);
        }
    }, 1000);
}

/**
 * è®¡ç®—ä¼˜åŒ–çš„EQè®¾ç½®
 */
function calculateOptimizedEQ(frequencies, spectrum, eqFrequencies, lowFreq, highFreq) {
    const optimizedEQ = new Array(eqFrequencies.length).fill(0);

    eqFrequencies.forEach((eqFreq, index) => {
        if (eqFreq < lowFreq || eqFreq > highFreq) {
            // è¶…å‡ºç›®æ ‡èŒƒå›´çš„é¢‘æ®µè®¾ç½®ä¸º-12dB
            optimizedEQ[index] = -12;
        } else {
            // åœ¨ç›®æ ‡èŒƒå›´å†…çš„é¢‘æ®µï¼Œè®¡ç®—éœ€è¦çš„æ ¡æ­£é‡
            const freqIndex = frequencies.findIndex(f => f >= eqFreq);
            if (freqIndex !== -1) {
                // ä½¿ç”¨æ’å€¼è·å–æ›´ç²¾ç¡®çš„å€¼
                let correction;
                if (freqIndex === 0 || frequencies[freqIndex] === eqFreq) {
                    correction = -spectrum[freqIndex]; // å–åï¼Œå› ä¸ºæˆ‘ä»¬è¦æ ¡æ­£åˆ°0dB
                } else {
                    // çº¿æ€§æ’å€¼
                    const f1 = frequencies[freqIndex - 1];
                    const f2 = frequencies[freqIndex];
                    const s1 = spectrum[freqIndex - 1];
                    const s2 = spectrum[freqIndex];
                    const ratio = (eqFreq - f1) / (f2 - f1);
                    correction = -(s1 + ratio * (s2 - s1));
                }

                // é™åˆ¶åœ¨Â±12dBèŒƒå›´å†…
                optimizedEQ[index] = Math.max(-12, Math.min(12, correction));
            }
        }
    });

    return optimizedEQ;
}

/**
 * æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
 */
function showSuccessMessage(message) {
    // åˆ›å»ºæˆåŠŸæç¤ºå…ƒç´ 
    const successDiv = document.createElement('div');
    successDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #d4edda;
        color: #155724;
        padding: 15px 20px;
        border: 1px solid #c3e6cb;
        border-radius: 6px;
        font-weight: 500;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        max-width: 400px;
    `;
    successDiv.textContent = message;

    document.body.appendChild(successDiv);

    // 3ç§’åè‡ªåŠ¨ç§»é™¤
    setTimeout(() => {
        if (successDiv.parentNode) {
            successDiv.parentNode.removeChild(successDiv);
        }
    }, 3000);
}

/**
 * å¯¼å‡ºEQæ•°æ®
 */
function exportEQData(eqType) {
    const settings = eqType === '15' ? eq15Settings : eq31Settings;
    const freqs = eqType === '15' ?
        [25, 40, 63, 100, 160, 250, 400, 630, 1000, 1600, 2500, 4000, 6300, 10000, 16000] :
        [20, 25, 31.5, 40, 50, 63, 80, 100, 125, 160, 200, 250, 315, 400, 500,
            630, 800, 1000, 1250, 1600, 2000, 2500, 3150, 4000, 5000, 6300,
            8000, 10000, 12500, 16000, 20000];

    let csvContent = 'Frequency (Hz),Gain (dB)\n';
    freqs.forEach((freq, index) => {
        csvContent += `${freq},${settings[index].toFixed(1)}\n`;
    });

    downloadCSV(csvContent, `EQ_${eqType}æ®µ_è®¾ç½®.csv`);
}

/**
 * å¯¼å‡ºå…¨éƒ¨EQæ•°æ®
 */
function exportBothEQData() {
    const eq15Freqs = [25, 40, 63, 100, 160, 250, 400, 630, 1000, 1600, 2500, 4000, 6300, 10000, 16000];
    const eq31Freqs = [20, 25, 31.5, 40, 50, 63, 80, 100, 125, 160, 200, 250, 315, 400, 500,
        630, 800, 1000, 1250, 1600, 2000, 2500, 3150, 4000, 5000, 6300,
        8000, 10000, 12500, 16000, 20000];

    let csvContent = 'EQ Type,Frequency (Hz),Gain (dB)\n';

    eq15Freqs.forEach((freq, index) => {
        csvContent += `15-Band,${freq},${eq15Settings[index].toFixed(1)}\n`;
    });

    eq31Freqs.forEach((freq, index) => {
        csvContent += `31-Band,${freq},${eq31Settings[index].toFixed(1)}\n`;
    });

    downloadCSV(csvContent, 'EQ_å…¨éƒ¨è®¾ç½®.csv');
}

/**
 * ä¸‹è½½CSVæ–‡ä»¶
 */
function downloadCSV(content, filename) {
    const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');

    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

/**
 * æ›´æ–°é¢‘ç‡æé™æ˜¾ç¤º
 */
function updateFrequencyLimits(limits) {
    if (!limits) return;

    const eq15LowLimit = document.getElementById('eq15LowLimit');
    const eq15HighLimit = document.getElementById('eq15HighLimit');
    const eq31LowLimit = document.getElementById('eq31LowLimit');
    const eq31HighLimit = document.getElementById('eq31HighLimit');

    if (eq15LowLimit && eq15HighLimit) {
        eq15LowLimit.textContent = limits.eq_15?.low ?
            Math.round(limits.eq_15.low) + ' Hz' : '-- Hz';
        eq15HighLimit.textContent = limits.eq_15?.high ?
            Math.round(limits.eq_15.high) + ' Hz' : '-- Hz';
    }

    if (eq31LowLimit && eq31HighLimit) {
        eq31LowLimit.textContent = limits.eq_31?.low ?
            Math.round(limits.eq_31.low) + ' Hz' : '-- Hz';
        eq31HighLimit.textContent = limits.eq_31?.high ?
            Math.round(limits.eq_31.high) + ' Hz' : '-- Hz';
    }
}

/**
 * æ˜¾ç¤ºéŸ³ç®±é—®é¢˜è¯Šæ–­
 */
function displaySpeakerIssues(issues) {
    const container = document.getElementById('speakerIssues');
    const content = document.getElementById('issuesContent');

    if (!issues || issues.length === 0) {
        container.style.display = 'none';
        return;
    }

    content.innerHTML = '';

    issues.forEach(issue => {
        const issueItem = document.createElement('div');
        issueItem.className = `issue-item ${issue.severity}`;
        issueItem.innerHTML = `
            <div class="issue-title ${issue.severity}">${issue.issue}</div>
            <div class="issue-description">${issue.description}</div>
            <div class="issue-suggestion"><strong>å»ºè®®:</strong> ${issue.suggestion}</div>
        `;
        content.appendChild(issueItem);
    });

    container.style.display = 'block';

    // åˆå§‹åŒ–æŠ˜å çŠ¶æ€
    initializeSpeakerIssuesState();
}


/**
 * æ˜¾ç¤ºåŠ è½½çŠ¶æ€
 */
function showLoading() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('error').style.display = 'none';
}

/**
 * éšè—åŠ è½½çŠ¶æ€
 */
function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

/**
 * æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
 */
function showError(message) {
    const errorDiv = document.getElementById('error');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';

    // 3ç§’åè‡ªåŠ¨éšè—
    setTimeout(() => {
        errorDiv.style.display = 'none';
    }, 3000);
}

/**
 * éšè—é”™è¯¯ä¿¡æ¯
 */
function hideError() {
    document.getElementById('error').style.display = 'none';
}

/**
 * æ˜¾ç¤ºé‡æ–°ä¸Šä¼ å¡ç‰‡
 */
function showReuploadCard() {
    document.getElementById('reuploadCard').style.display = 'block';
}

/**
 * é‡ç½®æ—¶ä¹Ÿè¦æ–­å¼€éŸ³é¢‘å¤„ç†
 */
function resetToUpload() {
    // åœæ­¢å¹¶æ–­å¼€éŸ³é¢‘
    if (currentAudio) {
        currentAudio.pause();
        URL.revokeObjectURL(currentAudio.src);
        currentAudio = null;
    }

    // æ–­å¼€éŸ³é¢‘å¤„ç†
    disconnectAudioProcessing();

    // é‡ç½®æ‰€æœ‰çŠ¶æ€
    selectedFiles = [];
    analysisResults = null;
    currentChart = null;
    currentEQType = 'none';
    isPlaying = false;
    eq15Settings = new Array(15).fill(0);
    eq31Settings = new Array(31).fill(0);
    eq15PageIndex = 0;
    eq31PageIndex = 0;

    // âœ… æ–°å¢ï¼šé‡ç½®æŠ˜å çŠ¶æ€
    algorithmSectionCollapsed = false;
    frequencyRangeSectionCollapsed = false;

    // é‡ç½®ç•Œé¢
    document.getElementById('uploadCard').style.display = 'block';
    document.getElementById('instructionsCard').style.display = 'block';
    document.getElementById('results').style.display = 'none';
    document.getElementById('eqConsole').style.display = 'none';
    document.getElementById('eqPlaceholder').style.display = 'block';
    document.getElementById('reuploadCard').style.display = 'none';
    document.getElementById('speakerIssues').style.display = 'none';
    document.getElementById('audioControlsPanel').style.display = 'none';

    // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨
    document.getElementById('fileList').innerHTML = '';
    document.getElementById('audioFiles').value = '';
    document.getElementById('testAudioFile').value = '';
    document.getElementById('analyzeBtn').disabled = true;

    // é‡ç½®éŸ³é¢‘ä¿¡æ¯
    document.getElementById('audioInfo').textContent = 'æœªé€‰æ‹©æ–‡ä»¶';

    // æ¸…ç©ºå›¾è¡¨
    document.getElementById('frequencyChart').innerHTML = '';

    // é‡ç½®EQæŒ‰é’®çŠ¶æ€
    const eqToggleButtons = document.querySelectorAll('.eq-toggle-button');
    eqToggleButtons.forEach(btn => btn.classList.remove('active'));
    document.querySelector('.eq-toggle-button[data-eq-type="none"]').classList.add('active');

    // ç§»é™¤æŠ˜å åŒºåŸŸ
    const algorithmSelector = document.querySelector('.algorithm-section');
    if (algorithmSelector) {
        algorithmSelector.remove();
    }

    hideError();
    hideLoading();
}

/**
 * åˆ‡æ¢éŸ³ç®±é—®é¢˜è¯Šæ–­å¡ç‰‡çš„å±•å¼€/æ”¶èµ·çŠ¶æ€
 */
function toggleSpeakerIssues() {
    const content = document.getElementById('issuesContent');
    const icon = document.getElementById('speakerIssuesIcon');

    speakerIssuesCollapsed = !speakerIssuesCollapsed;

    if (speakerIssuesCollapsed) {
        content.classList.add('collapsed');
        icon.classList.add('collapsed');
        icon.textContent = 'â–¶';
    } else {
        content.classList.remove('collapsed');
        icon.classList.remove('collapsed');
        icon.textContent = 'â–¼';
    }

    // ä¿å­˜çŠ¶æ€åˆ°localStorageï¼ˆå¯é€‰ï¼‰
    try {
        localStorage.setItem('speakerIssuesCollapsed', speakerIssuesCollapsed.toString());
    } catch (e) {
        // å¿½ç•¥localStorageé”™è¯¯
    }
}

/**
 * åˆå§‹åŒ–éŸ³ç®±é—®é¢˜è¯Šæ–­å¡ç‰‡çŠ¶æ€
 */
function initializeSpeakerIssuesState() {
    // ä»localStorageæ¢å¤çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
    try {
        const savedState = localStorage.getItem('speakerIssuesCollapsed');
        if (savedState === 'true') {
            speakerIssuesCollapsed = false; // å…ˆè®¾ä¸ºfalseï¼Œç„¶åè°ƒç”¨toggle
            toggleSpeakerIssues();
        }
    } catch (e) {
        // å¿½ç•¥localStorageé”™è¯¯
    }
}

/**
 * ä½¿ç›®æ ‡é¢‘ç‡èŒƒå›´åŒºåŸŸå˜ä¸ºå¯æŠ˜å 
 */
function makeFrequencyRangeCollapsible() {
    // ä¿®æ”¹é€‰æ‹©å™¨é€»è¾‘ï¼šæ‰¾åˆ°æ‰€æœ‰h4ï¼Œç„¶åç­›é€‰å‡º"ç›®æ ‡é¢‘ç‡èŒƒå›´"
    const allH4s = document.querySelectorAll('.eq-section h4');
    let frequencyRangeSection = null;

    for (let h4 of allH4s) {
        if (h4.textContent.trim() === 'ç›®æ ‡é¢‘ç‡èŒƒå›´') {
            frequencyRangeSection = h4;
            break;
        }
    }

    if (!frequencyRangeSection) {
        console.warn('æœªæ‰¾åˆ°ç›®æ ‡é¢‘ç‡èŒƒå›´åŒºåŸŸ');
        return;
    }

    const parentSection = frequencyRangeSection.parentElement;

    // ä¸ºçˆ¶å®¹å™¨æ·»åŠ æŠ˜å æ ·å¼ç±»
    parentSection.classList.add('collapsible-section', 'frequency-range-section');

    // åˆ›å»ºå¯æŠ˜å çš„å¤´éƒ¨
    const collapsibleHeader = document.createElement('div');
    collapsibleHeader.className = 'collapsible-header';
    collapsibleHeader.innerHTML = `
        <h4>ç›®æ ‡é¢‘ç‡èŒƒå›´</h4>
        <span class="collapse-icon" id="frequencyRangeIcon">â–¼</span>
    `;

    // åˆ›å»ºå¯æŠ˜å çš„å†…å®¹åŒºåŸŸ
    const collapsibleContent = document.createElement('div');
    collapsibleContent.className = 'collapsible-content';
    collapsibleContent.id = 'frequencyRangeContent';

    // å°†åŸæœ‰å†…å®¹ç§»åŠ¨åˆ°å¯æŠ˜å åŒºåŸŸä¸­
    const originalContent = parentSection.innerHTML;
    parentSection.innerHTML = '';

    // é‡æ–°æ„å»ºå†…å®¹ï¼Œæ’é™¤åŸæœ‰çš„h4æ ‡é¢˜
    collapsibleContent.innerHTML = originalContent.replace(/<h4[^>]*>ç›®æ ‡é¢‘ç‡èŒƒå›´<\/h4>/, '');

    // æ·»åŠ æ–°çš„ç»“æ„
    parentSection.appendChild(collapsibleHeader);
    parentSection.appendChild(collapsibleContent);

    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
    collapsibleHeader.addEventListener('click', toggleFrequencyRangeSection);

    console.log('ç›®æ ‡é¢‘ç‡èŒƒå›´åŒºåŸŸå·²è®¾ç½®ä¸ºå¯æŠ˜å ');
}

/**
 * åˆ‡æ¢é¢‘ç‡èŒƒå›´åŒºåŸŸçš„æŠ˜å çŠ¶æ€
 */
function toggleFrequencyRangeSection() {
    const content = document.getElementById('frequencyRangeContent');
    const icon = document.getElementById('frequencyRangeIcon');

    if (!content || !icon) {
        console.warn('æœªæ‰¾åˆ°é¢‘ç‡èŒƒå›´æŠ˜å å…ƒç´ ');
        return;
    }

    frequencyRangeSectionCollapsed = !frequencyRangeSectionCollapsed;

    if (frequencyRangeSectionCollapsed) {
        content.classList.add('collapsed');
        icon.classList.add('collapsed');
        icon.textContent = 'â–¶';
    } else {
        content.classList.remove('collapsed');
        icon.classList.remove('collapsed');
        icon.textContent = 'â–¼';
    }

    // ä¿å­˜çŠ¶æ€åˆ°localStorageï¼ˆå¯é€‰ï¼‰
    try {
        localStorage.setItem('frequencyRangeSectionCollapsed', frequencyRangeSectionCollapsed.toString());
    } catch (e) {
        // å¿½ç•¥localStorageé”™è¯¯
    }

    console.log(`é¢‘ç‡èŒƒå›´åŒºåŸŸæŠ˜å çŠ¶æ€: ${frequencyRangeSectionCollapsed ? 'æŠ˜å ' : 'å±•å¼€'}`);
}



/**
 * åˆ‡æ¢ç®—æ³•é€‰æ‹©åŒºåŸŸçš„æŠ˜å çŠ¶æ€
 */
function toggleAlgorithmSection() {
    const content = document.querySelector('.algorithm-selector-section .collapsible-content');
    const icon = document.getElementById('algorithmSectionIcon');

    if (!content || !icon) {
        console.warn('æœªæ‰¾åˆ°ç®—æ³•é€‰æ‹©æŠ˜å å…ƒç´ ');
        return;
    }

    algorithmSectionCollapsed = !algorithmSectionCollapsed;

    if (algorithmSectionCollapsed) {
        content.classList.add('collapsed');
        icon.classList.add('collapsed');
        icon.textContent = 'â–¶';
    } else {
        content.classList.remove('collapsed');
        icon.classList.remove('collapsed');
        icon.textContent = 'â–¼';
    }

    // ä¿å­˜çŠ¶æ€åˆ°localStorageï¼ˆå¯é€‰ï¼‰
    try {
        localStorage.setItem('algorithmSectionCollapsed', algorithmSectionCollapsed.toString());
    } catch (e) {
        // å¿½ç•¥localStorageé”™è¯¯
    }

    console.log(`ç®—æ³•é€‰æ‹©åŒºåŸŸæŠ˜å çŠ¶æ€: ${algorithmSectionCollapsed ? 'æŠ˜å ' : 'å±•å¼€'}`);
}


/**
 * åˆå§‹åŒ–æ‰€æœ‰æŠ˜å åŒºåŸŸçš„çŠ¶æ€
 */
function initializeCollapsibleSections() {
    // æ¢å¤ç®—æ³•é€‰æ‹©åŒºåŸŸçš„çŠ¶æ€
    try {
        const algorithmState = localStorage.getItem('algorithmSectionCollapsed');
        if (algorithmState === 'true') {
            algorithmSectionCollapsed = false; // å…ˆè®¾ä¸ºfalseï¼Œç„¶åè°ƒç”¨toggle
            setTimeout(() => {
                toggleAlgorithmSection();
            }, 100);
        }
    } catch (e) {
        console.warn('æ¢å¤ç®—æ³•é€‰æ‹©åŒºåŸŸçŠ¶æ€å¤±è´¥:', e);
    }

    // æ¢å¤é¢‘ç‡èŒƒå›´åŒºåŸŸçš„çŠ¶æ€
    try {
        const frequencyState = localStorage.getItem('frequencyRangeSectionCollapsed');
        if (frequencyState === 'true') {
            frequencyRangeSectionCollapsed = false; // å…ˆè®¾ä¸ºfalseï¼Œç„¶åè°ƒç”¨toggle
            setTimeout(() => {
                toggleFrequencyRangeSection();
            }, 150);
        }
    } catch (e) {
        console.warn('æ¢å¤é¢‘ç‡èŒƒå›´åŒºåŸŸçŠ¶æ€å¤±è´¥:', e);
    }

    console.log('æŠ˜å åŒºåŸŸçŠ¶æ€åˆå§‹åŒ–å®Œæˆ');
}

/**
 * æ”¹è¿›çš„ç®—æ³•é€‰æ‹©å™¨æ·»åŠ å‡½æ•° - æ·»åŠ æŠ˜å åŠŸèƒ½
 */
function addSmoothingControlToEQAreaWithCollapse() {
    const eqConsole = document.getElementById('eqConsole');

    // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡æ§ä»¶
    if (document.getElementById('algorithmSelector')) {
        return;
    }

    // åˆ›å»ºç®—æ³•é€‰æ‹©å™¨åŒºåŸŸ - å¯æŠ˜å ç‰ˆæœ¬
    const algorithmSelectorSection = document.createElement('div');
    algorithmSelectorSection.className = 'eq-section algorithm-selector-section collapsible-section';
    algorithmSelectorSection.style.cssText = 'border-bottom: 2px solid #e9ecef; padding-bottom: 20px; margin-bottom: 25px;';

    algorithmSelectorSection.innerHTML = `
        <div class="collapsible-header" onclick="toggleAlgorithmSection()">
            <h4>EQç®—æ³•é€‰æ‹©</h4>
            <span class="collapse-icon" id="algorithmSectionIcon">â–¼</span>
        </div>
        <div class="collapsible-content" id="algorithmSectionContent">
            <div id="algorithmSelector" class="algorithm-selector">
                <div class="algorithm-option">
                    <label class="algorithm-label">
                        <input type="radio" name="eqAlgorithm" value="smoothed" id="algorithmSmoothed" checked>
                        <span class="radio-checkmark"></span>
                        <div class="algorithm-info">
                            <span class="algorithm-title">å¹³æ»‘ä¼˜åŒ–ç®—æ³•</span>
                            <span class="algorithm-desc">å‡å°‘400Hzä»¥ä¸Šé¢‘æ®µå…±é¸£ï¼Œå¬æ„Ÿæ›´è‡ªç„¶ï¼ˆæ¨èï¼‰</span>
                        </div>
                    </label>
                </div>
                <div class="algorithm-option">
                    <label class="algorithm-label">
                        <input type="radio" name="eqAlgorithm" value="precise" id="algorithmPrecise">
                        <span class="radio-checkmark"></span>
                        <div class="algorithm-info">
                            <span class="algorithm-title">ç²¾ç¡®æ ¡æ­£ç®—æ³•</span>
                            <span class="algorithm-desc">ä¸¥æ ¼æŒ‰æµ‹é‡æ•°æ®æ ¡æ­£ï¼Œé€‚åˆä¸“ä¸šç›‘å¬</span>
                        </div>
                    </label>
                </div>
            </div>
            <div class="algorithm-actions">
                <button class="btn btn-algorithm" onclick="applySelectedAlgorithm()">åº”ç”¨é€‰æ‹©çš„ç®—æ³•</button>
                <div class="algorithm-status" id="currentAlgorithmStatus">
                    å½“å‰ï¼šå¹³æ»‘ä¼˜åŒ–ç®—æ³•
                </div>
            </div>
        </div>
    `;

    // æ’å…¥åˆ°åˆé€‚ä½ç½® - éœ€è¦æ›´ç²¾ç¡®çš„é€‰æ‹©å™¨
    // æ‰¾åˆ°"æ•°æ®å¯¼å‡º"ä¹‹åçš„ç¬¬ä¸€ä¸ªeq-section
    const allSections = eqConsole.querySelectorAll('.eq-section');
    let targetSection = null;

    // å¯»æ‰¾"ç›®æ ‡é¢‘ç‡èŒƒå›´"åŒºåŸŸä½œä¸ºæ’å…¥ç‚¹
    for (let section of allSections) {
        const h4 = section.querySelector('h4');
        if (h4 && h4.textContent.trim() === 'ç›®æ ‡é¢‘ç‡èŒƒå›´') {
            targetSection = section;
            break;
        }
    }

    if (targetSection) {
        // åœ¨"ç›®æ ‡é¢‘ç‡èŒƒå›´"ä¹‹å‰æ’å…¥
        eqConsole.insertBefore(algorithmSelectorSection, targetSection);
    } else {
        // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œæ’å…¥åˆ°ç¬¬äºŒä¸ªä½ç½®ï¼ˆæ•°æ®å¯¼å‡ºä¹‹åï¼‰
        const firstEQSection = eqConsole.querySelector('.eq-section:nth-child(2)');
        if (firstEQSection) {
            eqConsole.insertBefore(algorithmSelectorSection, firstEQSection);
        } else {
            eqConsole.appendChild(algorithmSelectorSection);
        }
    }

    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    initializeAlgorithmSelector();

    console.log('ç®—æ³•é€‰æ‹©å™¨ï¼ˆå¯æŠ˜å ç‰ˆæœ¬ï¼‰æ·»åŠ å®Œæˆ');
}

// å¯¼å‡ºä¸»è¦å‡½æ•°ä¾›HTMLè°ƒç”¨
window.analyzeAudio = analyzeAudio;
window.removeFile = removeFile;
window.resetToUpload = resetToUpload;
window.changePage = changePage;
window.resetEQ = resetEQ;
window.zeroAllEQ = zeroAllEQ;
window.exportEQData = exportEQData;
window.exportBothEQData = exportBothEQData;
window.updateFrequencyRange = updateFrequencyRange;
window.reoptimizeEQ = reoptimizeEQ;
window.togglePlayPause = togglePlayPause;
window.stopAudio = stopAudio;
window.rewindAudio = rewindAudio;
window.seekAudio = seekAudio;

// å¯¼å‡ºå‡½æ•°
window.loadAudioFile = loadAudioFile;
window.togglePlayPause = togglePlayPause;
window.setEQValue = setEQValue;
window.resetToUpload = resetToUpload;
window.testLoudnessMatching = testLoudnessMatching;

window.toggleSpeakerIssues = toggleSpeakerIssues;

window.applySelectedAlgorithm = applySelectedAlgorithm;

window.toggleFrequencyRangeSection = toggleFrequencyRangeSection;
window.toggleAlgorithmSection = toggleAlgorithmSection;
// ===== web.js ç»“æŸ =====

</script>
</body>

</html>